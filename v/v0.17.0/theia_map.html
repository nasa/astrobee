<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Building a map with Theia</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.0</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('theia_map.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Building a map with Theia </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Theia (<a href="https://github.com/sweeneychris/TheiaSfM">https://github.com/sweeneychris/TheiaSfM</a>) is a package for global structure-from-motion (SfM). It may be faster and require less user effort than the method used in Astrobee (see <a class="el" href="map_building.html">Map building</a>) which consists of creating submaps using incremental SfM on sequences of images that overlap with their immediate neighbors, followed by merging the submaps. Theia uses "cascade matching" to handle non-sequential image acquisitions.</p>
<p>The Theia approach was tested on about 700 images acquired at different times and it did well. It is currently studied as an alternative to Astrobee's approach.</p>
<h1><a class="anchor" id="autotoc_md429"></a>
Install Theia's prerequisites</h1>
<p>It is suggested to use <code>conda</code> to install Theia's dependencies. The conda toolset does not require root access and creates a set of consistent libraries at a custom location in your home directory, which are largely independent of your particular Linux system.</p>
<p>For the record, the instructions below were tested on Ubuntu 18.04.</p>
<p>Fetch and install <code>conda</code> from: </p><pre class="fragment">https://docs.conda.io/projects/conda/en/latest/user-guide/install/linux.html
</pre><p>Restart your shell if it is suggested to do so.</p>
<p>Create and activate the environment: </p><pre class="fragment">conda create -n theia   
conda activate theia
</pre><p>Run the following command to install some packages and GCC 11: </p><pre class="fragment">conda install -c conda-forge cmake                \
  gcc_linux-64==11.1.0 gxx_linux-64==11.1.0       \
  lapack blas eigen==3.3.7 suitesparse rapidjson  \
  glog gflags rocksdb OpenImageIO                 \
  ceres-solver=1.14.0=h0948850_10
</pre><p>The Ceres package can be quite particular about the version of Eigen it uses, and some versions of Ceres are not built with <code>suitesparse</code>, which is a sparse solver that is needed for best performance, so some care is needed with choosing the versions of the packages.</p>
<h1><a class="anchor" id="autotoc_md430"></a>
Fetch and build Theia</h1>
<pre class="fragment">git clone git@github.com:sweeneychris/TheiaSfM.git
cd TheiaSfM
git checkout d2112f1 # this version was tested
</pre><p>Edit the file: </p><pre class="fragment">applications/CMakeLists.txt
</pre><p>and comment out all the lines regarding OpenGL, GLEW, GLUT, and view_reconstruction. That visualizer logic is not easy to compile and is not needed.</p>
<p>Run <code>which cmake</code> to ensure its version in the <code>theia</code> environemnt installed earlier is used. Otherwise run again: </p><pre class="fragment">conda activate theia
</pre><p>Do: </p><pre class="fragment">mkdir build
cd build
cmake ..
make -j 20
</pre><p>This will create the executables <code>build_reconstruction</code> and <code>export_to_nvm_file</code> in the <code>bin</code> subdirectory of <code>build</code>.</p>
<h1><a class="anchor" id="autotoc_md431"></a>
Hide the conda environment</h1>
<p>The conda environment set up earlier will confuse the lookup the dependencies for the Astrobee libraries. Hence remove the block of lines starting and ending with <code>conda initialize</code> which conda added to your ~/.bashrc, then close and reopen your terminal. Ensure that the <code>env</code> command shows no mention of conda.</p>
<h1><a class="anchor" id="autotoc_md432"></a>
Set up the environment for Theia and Astrobee</h1>
<p>Add the Theia tools to your path as: </p><pre class="fragment">export PATH=/path/to/TheiaSfM/build/bin:$PATH
</pre><p>Set up the environment for Astrobee, including the robot name. These should be adjusted as needed: </p><pre class="fragment">export ASTROBEE_BUILD_PATH=$HOME/astrobee
export ASTROBEE_SOURCE_PATH=$ASTROBEE_BUILD_PATH/src
source $ASTROBEE_BUILD_PATH/devel/setup.bash
export ASTROBEE_RESOURCE_DIR=$ASTROBEE_SOURCE_PATH/astrobee/resources
export ASTROBEE_CONFIG_DIR=$ASTROBEE_SOURCE_PATH/astrobee/config
export ASTROBEE_WORLD=iss
export ASTROBEE_ROBOT=bumble
</pre><p>Add some Astrobee tools to the path as well: </p><pre class="fragment">export PATH=$ASTROBEE_BUILD_PATH/devel/lib/sparse_mapping:$PATH
</pre><p>Please note that if the robot name, as specified in <code>ASTROBEE_ROBOT</code>, is incorrect, you will get poor results.</p>
<h1><a class="anchor" id="autotoc_md433"></a>
Prepare the data</h1>
<p>The data preparation is the same as used with the usual Astrobee map-building software documented in <a class="el" href="map_building.html">Map building</a>. To summarize, the steps are as follows.</p>
<p>Extract the data from the bag: </p><pre class="fragment">$ASTROBEE_BUILD_PATH/devel/lib/localization_node/extract_image_bag \
  bagfile.bag -use_timestamp_as_image_name                         \
  -image_topic /hw/cam_nav -output_directory image_dir
</pre><p>If the images were recorded with the image sampler, the nav_cam image topic needs to be changed to: </p><pre class="fragment">/mgt/img_sampler/nav_cam/image_record
</pre><p>The <code>-use_timestamp_as_image_name</code> option is not strictly necessary, but it is helpful if a lot of datasets needs to be processed jointly. With it, the image filename is the timestamp (in double-precision seconds since epoch), which provides for a rather unique name, as compared to using the image index in the bag without that option.</p>
<p>Partition image files into movement sequences and reduce the number of images to improve bundle-adjustment accuracy rosrun <a class="el" href="namespacesparse__mapping.html">sparse_mapping</a> process_sequential_images.py image_directory_name config_path</p>
<p>Partitions a sequentially ordered set of image files into valid, rotation, and invalid sequences. During bundle adjustment, it is useful to avoid adding pure rotation sequences initially as these cause errors for monocular systems. The resulting sequences can be individually bundle-adjusted and merged as described later, generally starting with the valid (non-rotation) sequences and optionally adding rotations at the end once enough matches exist in the map. Also deletes subsequent images with low movement from that directory to improve mapping performance and accuracy. See 'rosrun <a class="el" href="namespacesparse__mapping.html">sparse_mapping</a> process_sequential_images.py -h' for more usage details, options, and instructions.</p>
<p>These are non-reversible operations, so they should be invoked on a copy of the images.</p>
<p>If possible, the robot should have some translation motion (in addition to any rotation) when the data is acquired.</p>
<p>Removing low movement images and initially only adding valid movement images helps the accuracy of bundle adjustment, which struggles to optimize camera poses with small or no translation changes.</p>
<p>Put the selected images in a list: </p><pre class="fragment">ls image_dir/*jpg &gt; image_list.txt
</pre><h1><a class="anchor" id="autotoc_md434"></a>
Run the Astrobee wrapper around the Theia tools</h1>
<pre class="fragment">python $ASTROBEE_SOURCE_PATH/localization/sparse_mapping/tools/build_theia_map.py \
   --output_map theia.map --work_dir theia_work --image_list image_list.txt
</pre><p>This will take care of preparing everything Theia needs, will run it, and will export the resulting map to Astrobee's expected format.</p>
<p>It is suggested to first run this tool on a small subset of the data, perhaps made up of 10 images. A 700-image dataset may take perhaps 6 hours on a machine with a couple of dozen cores and use up perhaps 20 GB of RAM.</p>
<p>The obtained map can be examined with <code>nvm_visualize</code>, as described in <a class="el" href="sparsemapping.html">Sparse mapping</a>.</p>
<p>The work directory can be deleted later.</p>
<h1><a class="anchor" id="autotoc_md435"></a>
Command line options</h1>
<p>This tool has the following command-line options: </p><pre class="fragment">--theia_flags: The flags to pass to Theia. If not specified, use
  localization/sparse_mapping/theia_flags.txt in the Astrobee repo.
--image_list: The list of distorted (original) nav cam images to
  use, one per line.
--output_map: The resulting output map.
--skip_rebuilding: Do not rebuild the map after importing it from
  Theia.
--work_dir: A temporary work directory to be deleted by the user
  later.
--keep_undistorted_images: Do not replace the undistorted images
  Theia used with the original distorted ones in the sparse map
  imported from Theia. This is for testing purposes.
--help: Show this help message and exit.
</pre><h1><a class="anchor" id="autotoc_md436"></a>
Next steps</h1>
<p>This map will need to be registered and visualized as described in <a class="el" href="map_building.html">Map building</a>.</p>
<p>That page also has information for how the map can be rebuilt to use BRISK features, and how it can be validated for localization by playing a bag against it.</p>
<p>The <a class="el" href="import_map.html">Importing a map in .nvm format</a> program is used by this tool to import a sparse map from Theia's format. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
