<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Mapper</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.0</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('mapper.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Mapper </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <a class="el" href="mapper.html">Mapper</a> node is responsible for maintaining a representation of the environment, which is in turn used by the <a class="el" href="namespaceplanner.html">planner</a> node for planning segments. Internally, the <a class="el" href="mapper.html">Mapper</a> stores a collection of keep-in and keep-out zones, as well as a map of the environment, which it builds by incrementally fusing measurements from picoflexx sensor(s). Ultimately, both representations are reduced by the <a class="el" href="mapper.html">Mapper</a> to a collection of free-space polygons, in which the <a class="el" href="namespaceplanner.html">planner</a> searches for a suitable path.</p>
<p>Observation: as of now, transformation of a map to free-space polygons is not yet implemented.</p>
<p>The <a class="el" href="mapper.html">Mapper</a> node can be divided in the following tasks:</p>
<ul>
<li><code>Octomapper</code> - Maps Astrobee's surroundings using an octomap (octree-based map);</li>
<li><code>Sentinel</code> - Checks for imminent collisions and notifies the controller if an imminent collision has been detected;</li>
</ul>
<h2><a class="anchor" id="autotoc_md449"></a>
Octomapper</h2>
<p>The Octomapper portion of the <a class="el" href="mapper.html">Mapper</a> creates a 3D occupancy map of the environment that maps known areas probabilistically. The Octomapper builds a representation of the environment (clutter topology) using measurements from the <a class="el" href="picoflexx.html">PicoFlexx</a> depth sensor. Mapping is done in the world frame, and the TF2 library is used to transform from the sensor frame to the world frame based on dynamic transforms published by the EKF, and static transforms published by <a class="el" href="framestore.html">Framestore</a>. It is based on the following work:</p>
<div class="fragment"><div class="line">@article{hornung2013octomap,</div>
<div class="line">  title={OctoMap: An efficient probabilistic 3D mapping framework based on octrees},</div>
<div class="line">  author={Hornung, Armin and Wurm, Kai M and Bennewitz, Maren and Stachniss, Cyrill and Burgard, Wolfram},</div>
<div class="line">  journal={Autonomous Robots},</div>
<div class="line">  volume={34},</div>
<div class="line">  number={3},</div>
<div class="line">  pages={189--206},</div>
<div class="line">  year={2013},</div>
<div class="line">  publisher={Springer}</div>
<div class="line">}</div>
</div><!-- fragment --><div class="image">
<img src="iss_sim_360_octomap.png" alt=""/>
<div class="caption">
alt text</div></div>
   <p>The Octomap library stores data in an Octree data structure. This implies in efficient memory allocation, since only known areas are stored in memory. Beyond that, this library enhances memory allocation efficiency by exploiting tree pruning methods.</p>
<p>In addition to that, Octomap constantly updates occupancy probabilities for every voxel (3D pixel) in the tree. Therefore, at every new point cloud measurement, the occupancy probabilities are updated through a Bayesian update.</p>
<p>Most of the code used in the <a class="el" href="mapper.html">Mapper</a> uses the API provided in the Octomap library. However, some extra functionality was added:</p>
<ul>
<li><code>Map inflation (C-expansion)</code> - This is important for collision checking and path planning.</li>
<li><code>Fading memory</code> - Since the main goal of the map is to be used for collision detection (and possibly local path planning), there is no need to store old information in the map. Hence, the <a class="el" href="mapper.html">Mapper</a> has a fading memory method that reduces map confidence as time goes by. When a voxel confidence reaches a certain threshold, it is deallocated from the map.</li>
</ul>
<p>The Octomapper subscribes to:</p>
<ul>
<li><code>point cloud data</code> - The map is updated based on point cloud data.</li>
<li><code>tf information</code> - In order to determine the location of the point cloud in the world frame, the mapper needs to rotate the point cloud data from camera frame to world frame. This is done by threads that listen to tf updates.</li>
</ul>
<p>The Octomapper publishes ROS visualization_markers, which can be used for human visual inspection of the map using RVIZ. It should be mentioned that these visualization_markers are only published if there is a subscriber to it. Hence, if nobody requests to see them in RVIZ, it won't be published. The importance of this is to avoid high-bandwidth information being sent across the network. Map visualization can be seen through the topics:</p>
<ul>
<li><code>mapper/obstacle_markers</code> - Visualization of the occupied voxels in the non-inflated map.</li>
<li><code>mapper/free_space_markers</code> - Visualization of the free voxels in the non-inflated map.</li>
<li><code>mapper/inflated_obstacle_markers</code> - Visualization of the occupied voxels in the inflated map.</li>
<li><code>mapper/inflated_free_space_markers</code> - Visualization of the free voxels in the inflated map.</li>
<li><code>mapper/frustum_markers</code> - visualization of the depth sensor frustum. This is useful for visualizing the sensor's field of view.</li>
</ul>
<p>The Octomapper takes the following paramers as inputs (defined in mapper.config):</p>
<ul>
<li><code>use_haz_cam</code> - Enables/disables the use of the haz_cam for mapping.</li>
<li><code>use_perch_cam</code> - Enables/disables the use of the perch_cam for mapping.</li>
<li><code>map_resolution (meters)</code> - Size of a voxel in the Octomap.</li>
<li><code>max_range (meters)</code> - Maximum reliable range of the depth camera.</li>
<li><code>min_range (meters)</code> - Minimum reliable range of the depth camera.</li>
<li><code>memory_time (seconds)</code> - How long the octomap remembers the fading memory map. It remembers forever when this variable is &lt;= 0.</li>
<li><code>robot_radius (meters)</code> - Radius of the robot considered in the planner.</li>
<li><code>collision_distance (meters)</code> - Minimum distance margin to maintain away from obstacles.</li>
<li><code>cam_fov (radians)</code> - Camera horizontal field-of-view. The octomap will only update the map in the volume within the fov of the depth cam.</li>
<li><code>cam_aspect_ratio</code> - Depth camera's width divided by height. Used for c alculating the camera's frustum.</li>
<li><code>occupancy_threshold</code> - Probability threshold above which a node is considered occupied.</li>
<li><code>probability_hit</code> - Probability that a measured obstacle is an obstacle (detection probability).</li>
<li><code>probability_miss</code> - Probability that a measured free area is an obstacle (false alarm).</li>
<li><code>clamping_threshold_min</code> - Minimum probability assigned as occupancy for a node. This should not be set to 0, because the probability of a free node being occupied might asymptotically converge to 0 as more measurements come in. If, however, this node becomes occupied sometime in the future, the Bayesian update would not trust the sensor anymore.</li>
<li><code>clamping_threshold_max</code> - Maximum probability assigned as occupancy for a node. This should not be set to 1, due to the considerations above.</li>
</ul>
<p>Some parameters of the Octomap can be changed during execution by calling the following services:</p>
<ul>
<li><code>mapper/update_resolution</code> - This updates the size of the voxels in the octomap. When called, this service will erase the whole map.</li>
<li><code>mapper/update_memory_time</code> - This updates the fading memory time.</li>
<li><code>mapper/update_inflation_radius</code> - Updates the inflation radius of the map. When called, this service will erase the whole map.</li>
<li><code>mapper/reset_map</code> - When called, this service will erase the whole map.</li>
</ul>
<h2><a class="anchor" id="autotoc_md450"></a>
Sentinel</h2>
<p>As its name suggests, the responsibility of the Sentinel is to look out for the safety of the platform. Unlike the <a class="el" href="namespaceplanner.html">planner</a>, which depends on map-building to proactively plan a safe path through a representation of the world, the sentinel node reacts to sensed data to check if the platform is likely to collide with an obstacle over some fixed time horizon, based on the segment it is currently following.</p>
<p><img src="/doc/images/mobility/sentinel2.png" alt="alt text" title="Collision avoidance" class="inline"/></p>
<p>The sentinel is activated when a new trajectory is published in <code>gnc/ctl/segment</code>. A subscriber gets the message and "voxelizes" the trajectory as shown in the pipeline below:</p>
<div class="image">
<img src="trajectory_voxelization.png" alt=""/>
<div class="caption">
alt text</div></div>
   <ul>
<li><code>Original Trajectory</code> - This is an example of a trajectory planned by Astrobee.</li>
<li><code>Oversampled Curve</code> - First thing we do in this pipeline is an oversampling (capture data with high sampling rate)</li>
<li><code>Downsample</code> - We perform a downsample using the algorithm from the paper shown below. In essence, we retain the samples such that straight lines between two samples deviate at most <code>traj_compression_max_dev</code> from the original curve. <div class="fragment"><div class="line">@inproceedings{bulut2007key,</div>
<div class="line">  title={Key frame extraction from motion capture data by curve saliency},</div>
<div class="line">  author={Bulut, Eyuphan and Capin, Tolga},</div>
<div class="line">  booktitle={Computer animation and social agents},</div>
<div class="line">  pages={119},</div>
<div class="line">  year={2007}</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><code>Bresenham (Voxelize)</code> - We use Bresenham's line algorithm to obtain the voxels between two samples.</li>
<li><code>One-neighbor Expansion</code> - We perform One-Neighbor Expansion on the previous set of voxels to obtain a more conservative result.</li>
</ul>
<p>It is important to mention that the resolution for the voxels in this pipeline does not need to match the resolution of the Octomap. We can use much smaller voxels here such that we are conservative enough (after the one-neighbor expansion), but we are not too conservative when checking these voxels against the map.</p>
<p>In parallel, a thread checks if the structure containing the voxelized trajectory is empty. If not, the voxelized trajectory will be compared against the octomap to search for collision. If a collision is found, the Sentinel notifies the motion controller by sending a std_msgs::PointStamped message to <code>mob/sentinel/collisions</code>, informing where and when the collision will happen.</p>
<p>Visualization of <code>oversampled trajectory</code>, <code>downsampled trajectory</code>, and final <code>voxelized trajectory</code> can be seen in Rviz by subscribing to <code>mapper/discrete_trajectory_markers</code>. These markers disappear when a collision is detected, or when a trajectory is fully executed.</p>
<p>The Sentinel has the following input parameters:</p>
<ul>
<li><code>traj_compression_max_dev (meters)</code> - Used in the <code>Downsampling</code> step of the pipeline above. The deviation of the straight lines w.r.t. the original curve is upper bounded by this parameter.</li>
<li><code>traj_compression_resolution (meters)</code> - Resolution (voxel size) of the voxelized trajectory. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
