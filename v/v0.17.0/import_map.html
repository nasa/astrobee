<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Importing a map in .nvm format</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.0</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('import_map.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Importing a map in .nvm format </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md396"></a>
Overview</h1>
<p>The <code>import_map</code> tool is used to import a map from the NVM format, which Theia and other SfM packages export to, to Astrobee's .map format. The <a class="el" href="export_map.html">Exporting a map to the .nvm format</a> program does the reverse operation.</p>
<p>It is assumed that the NVM map was built with nav_cam images, which were either undistorted or distorted (original ones), and that the name of the robot which acquired the images is known.</p>
<p>In either case, the NVM file does not store descriptors, so a map needs to be rebuilt after it is imported.</p>
<h1><a class="anchor" id="autotoc_md397"></a>
Import an nvm map made with distorted images</h1>
<p>Run: </p><pre class="fragment">export ASTROBEE_ROBOT=bumble
astrobee/devel/lib/sparse_mapping/import_map \
  -input_map map.nvm -output_map map.map
</pre><p>The nvm file normally stores distorted interest points which are shifted relative to the optical center. The import operation unshifts these points, undistorts them, and shifts them relative to unidstored image center, per Astrobee sparse map conventions.</p>
<p>If the interest points are saved with no shift relative to the optical center (such as done by <code>export_map -no_shift), then invoke on importing the</code>-no_shift`` option as well. The rest of the operations, of undistortion and shifting relative to the undistorted image center will still take place.</p>
<p>See further down about how to rebuild the imported map.</p>
<h1><a class="anchor" id="autotoc_md398"></a>
Import an nvm map made with undistorted images</h1>
<p>There are two cases to consider.</p>
<h2><a class="anchor" id="autotoc_md399"></a>
Keep, after importing, the undistorted images and camera model</h2>
<p>Run: </p><pre class="fragment">export ASTROBEE_ROBOT=bumble
astrobee/devel/lib/sparse_mapping/import_map                             \
  -undistorted_camera_params "wid_x wid_y focal_len opt_ctr_x opt_ctr_y" \
  &lt;undistorted images&gt;                                                   \
  -input_map map.nvm -output_map map.map
</pre><p>It is very important that the robot name be specified corretly.</p>
<p>It is assumed that the images were acquired with the nav camera of the robot given by $ASTROBEE_ROBOT and undistorted with the Astrobee program <code>undistort_image</code>. The undistorted camera parameters to use should be as printed on the screen (and saved to disk) by <code>undistort_image</code>.</p>
<h2><a class="anchor" id="autotoc_md400"></a>
Replace with distorted data</h2>
<p>If desired to replace on importing the undistorted images with the original distorted ones, and same for the camera parameters, as it is usually expected of a sparse map, the above command should be called instead as: </p><pre class="fragment">export ASTROBEE_ROBOT=bumble
astrobee/devel/lib/sparse_mapping/import_map \
  -undistorted_images_list undist_list.txt   \
  -distorted_images_list dist_list.txt       \
  -input_map map.nvm -output_map map.map
</pre><p>Here, the files <code>undist_list.txt</code> and <code>dist_list.txt</code> must have one image per line and be in one-to-one correspondence. It is important that both undistorted and distorted images be specified, as the former are needed to look up camera poses and other data in the .nvm file before being replaced with the distorted ones.</p>
<p>This use case was tested only with a map exported by Theia, which records the images without a directory path, so that is how they should be specified in the undistorted image list as well.</p>
<p>It is very important to note that the interest point matches will not be correct, as they are left undistorted. Only the image names, robot camera parameters, and camera poses will be accurate. So, this map should be rebuilt right away.</p>
<h1><a class="anchor" id="autotoc_md401"></a>
Rebuilding an imported map</h1>
<p>To rebuild an imported map while keeping the camera poses read from the nvm file, run: </p><pre class="fragment">export ASTROBEE_ROBOT=bumble
build_map -rebuild -rebuild_detector SURF \
 -output_map map.map 
</pre><p>To also reoptimize the camera poses, add the option: </p><pre class="fragment">-rebuild_refloat_cameras
</pre><p>Do not use this option with the BRISK detector, as this detector may not create enough features for the camera poses to be optimized correctly.</p>
<p>Note that if the NVM file is created by Theia, it may have the image names be specified without the path to the directory having them (that is, instead of image_dir/image1.jpg it may list just image1.jpg). Then this NVM file needs to be edited manually to add the correct path to the images before running the import tool. This is taken care of if both <code>-undistorted_images_list</code> and <code>-distorted_images_list</code> are specified. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
