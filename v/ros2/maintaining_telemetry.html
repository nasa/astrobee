<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Maintaining Astrobee Telemetry Backward Compatibility</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.0</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('maintaining_telemetry.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Maintaining Astrobee Telemetry Backward Compatibility </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md124"></a>
Motivation and scope</h2>
<p>The Astrobee Facility has built up a valuable archive of telemetry bags recorded by Astrobee robots on the ISS since commissioning in April</p><ol type="1">
<li>Astrobee's flight software (FSW) has also changed substantially over that time, including several changes to the definitions of the message types contained in the telemetry bags. As a result, it has become more difficult over time to analyze or play back older legacy bags with the latest version of FSW.</li>
</ol>
<p>This document establishes objectives for backward compatibility and proposes a maintenance approach.</p>
<h2><a class="anchor" id="autotoc_md125"></a>
Telemetry maintenance objectives</h2>
<ol type="1">
<li>Astrobee developers should be able to <code>rosbag play</code> archived Astrobee ISS telemetry bags with the latest FSW, as a way to test the software in the ISS environment. For example, localization system development has relied heavily on bag playback as a way to iterate and overcome challenges related to the complex ISS interior that can't be replicated on the ground.</li>
<li>External users without prior ROS experience should be able to analyze archived Astrobee ISS telemetry bags with minimal training by following simple, documented processes. These users could be Astrobee guest scientists or could be third parties with less Astrobee background and insider access who are opportunistically finding new uses for our archived data. (For example, making new observations in our ISS imagery.)</li>
<li>We also have a priority list of bad outcomes to avoid:<ul>
<li>Misleading users. If the message semantics has changed such that trying to interpret legacy messages with the new semantics is actively misleading, this is the worst case.</li>
<li>Breaking all messages. Some bag analysis tools are sensitive and crash if the bag has even a single problematic message definition. We should strive hard to avoid this problem.</li>
<li>Loss of ability to analyze specific message types or specific fields. This may be more acceptable, depending on the specific user needs.</li>
</ul>
</li>
<li>We should minimize the burden on Astrobee developers and the Astrobee Facility ops team required to realize these goals.</li>
</ol>
<h2><a class="anchor" id="autotoc_md126"></a>
Telemetry maintenance requirements</h2>
<ol type="1">
<li>Developers should have guidance about steps they can take to maintain legacy bag compatibility with minimum effort (this document).</li>
<li>Any required bag processing should be fully automated to the greatest extent possible, minimizing burden on the Astrobee Facility and users.</li>
<li>Bags processed for developers or external users to work with should pass <code>rosbag check</code>. This tool applies a number of tests, but is principally designed to check that the bag's messages can be played back with the latest version of the FSW ROS environment (the message definitions are compatible for all of the message types recorded in the bag).</li>
<li>Along the same lines, another test bags should pass is <code>rostopic echo -b &lt;bag&gt; -a</code>. This forces message deserialization.</li>
</ol>
<ol type="1">
<li>Where message semantics have changed, we should either remap the legacy message contents to accurately reflect the latest semantics, or rename the legacy message type to clarify that it can't be interpreted like the current type.</li>
<li>ROS message types defined by guest scientists:<ul>
<li>If legacy bag compatibility is required for these messages, it should be the responsibility of the guest science developers.</li>
<li>As a fallback, the FSW team should provide a tool for filtering out no-longer-compatible guest science messages, in case the other messages in the bag are still valuable.</li>
</ul>
</li>
<li>Out of scope: The primary focus is on legacy messages recorded in ISS telemetry bags, or particularly important ground experiments. We will avoid investing effort in backward compatibility with old message definitions that were never recorded on the ISS. For example, certain older versions of Astrobee perching messages were tested on the ground, but never deployed on the ISS, and in those cases backward compatibility is not important.</li>
</ol>
<h2><a class="anchor" id="autotoc_md127"></a>
Telemetry maintenance approach</h2>
<p>We will provide a fully automated script that can fix arbitrary legacy ISS Astrobee bags to be compatible with the latest FSW.</p>
<p>The starting point for the script is the standard <a href="http://wiki.ros.org/rosbag/migration"><code>rosbag</code> migration</a> system provided with ROS. If we invest in maintaining the necessary <code>*.bmr</code> bag migration rules, the <code>rosbag fix</code> script can fix most but not all message definition problems.</p>
<p>One remaining problem is incomplete message definitions in messages published by <code>rosjava</code> nodes. We have a script that can fix these message definitions. It must be run before <code>rosbag fix</code> in order to avoid a crash.</p>
<p>The other remaining problem arises when there are substantial changes in a message definition that make migration to the new definition problematic. For example:</p>
<ul>
<li>If a field has been deleted, any attempt to migrate an old message instance to the new definition will necessarily involve data loss.</li>
<li>If the change is sufficiently complicated, it may not be worth the effort to figure out how to reliably remap old data into the new structure.</li>
</ul>
<p>When migration is problematic, we will instead "freeze" the old message definition by copying it to a legacy message type name, and rename the message type in legacy bags to use the frozen type name.</p>
<h2><a class="anchor" id="autotoc_md128"></a>
Developer guidelines for modifying messages</h2>
<ul>
<li>Begin by trying hard to get the initial design of any new messages correct on the first pass, avoiding later changes that will cause a migration hassle.</li>
<li>However, you can change a message's definition without worrying about backward compatibility considerations up until the point when precious (ISS) data is recorded.</li>
<li>Try to avoid message definition changes that are problematic for backward compatibility.<ul>
<li>Adding a field is easy. However, if there is legacy data that needs to be migrated, try to design the new field to accommodate a clear no-data value that can be used to migrate old messages that didn't contain the field. (For example, rather than a <code>bool</code> field, you might prefer to use an <code>int8</code> field with enumerated values that include an explicit no-data value.)</li>
<li>Deleting a field is problematic for migration, assuming the field had any value when recorded in legacy messages. (Migrating to the new message type could lose precious data.) This might or might not be acceptable, depending on the situation.</li>
<li>Try hard to avoid renumbering the label values for enumerated types. If you do that, message migration will have to remap the legacy values to the new values (which is complicated and error-prone), or risk keeping values that are actively misleading for data analysis. Instead, you should assign never-before-used values as needed for new labels. If some old labels are no longer used in new messages, you should still keep them in the message definition as documentation for interpreting legacy messages. However, it's encouraged to clarify their legacy status (e.g., add a comment, or even prepend <code>OLD_</code> to the label text).</li>
<li>If the message changes are so involved that you can't figure out how you would migrate old message data to the new message type, consider whether it might be better to simply define a brand-new message type.</li>
</ul>
</li>
<li>Legacy message types that were recorded in precious (ISS) bags but are no longer published by the current software should not be deleted by default, because they remain useful for backward compatibility with the archived bags. Instead, document the legacy status of the message (e.g., add it to a list of messages that are only present for backward compatibility).</li>
<li>When you make a message definition change that is compatible with <code>rosbag</code> migration, please define a migration rule for the message at the same time, following the <a href="http://wiki.ros.org/rosbag/migration">migration instructions</a>, ideally using section 3.1 "Preferred Approach".<ul>
<li>Place your <code>*.bmr</code> file in the <code>bmr</code> folder of the appropriate ROS package. See <a href="https://github.com/nasa/astrobee/tree/develop/communications/ff_msgs/bmr"><code>ff_msgs/bmr</code></a> for an example of naming and styling conventions.</li>
<li>It is not necessary to export your <code>*.bmr</code> file in <code>package.xml</code> as documented in section 4. Unfortunately, that helps only if <code>rosdep</code> is configured on your host, which we can't always count on. Instead, our automated bag processing keeps a list of folders to search for migration rules.</li>
<li>Once your <code>*.bmr</code> file is added, <code>rosbag_fix_all.py</code> will apply your migration rules as needed.</li>
<li>Verify your new rule, as described below.</li>
</ul>
</li>
<li>If you are contemplating a new message definition change that is too involved for migration to be feasible, you should probably just define a brand-new message type instead and avoid any migration hassle. However, we already have past message changes of this flavor built up as technical debt. We deal with them by "freezing" a legacy copy of the old message definition. Follow these conventions:<ul>
<li>Messages are frozen by copying their definition files (e.g., <code>*.msg</code> or <code>*.action</code>).</li>
<li>To avoid clutter, the frozen copies may be placed in their own package, for example <code>ff_legacy_msgs</code> for messages from <code><a class="el" href="namespaceff__msgs.html">ff_msgs</a></code> or <code><a class="el" href="namespaceff__hw__msgs.html">ff_hw_msgs</a></code>.</li>
<li>Files defining frozen messages should be named by appending a version number to the original filename. For example, <code>Inspection.action</code> would become <code>InspectionV1.action</code>.</li>
<li>When you freeze a parent type, you should also freeze any subtypes contained in its fields, if there is any chance their definition could change in the future.</li>
<li>Add a rule for renaming the message type, as follows:<ul>
<li>Append your rule to the list in the <code>rename_types</code> field of the file named <code>bmr/rewrite_types_rules.json</code> within the relevant ROS package, such as <code><a class="el" href="namespaceff__msgs.html">ff_msgs</a></code>.</li>
<li>Your rule must specify these four fields:<ul>
<li><code>old_type</code>: The old message type name in <code>some_pkg/SomeMsg</code> format.</li>
<li><code>old_type_md5sum</code>: You can determine the MD5 sum for the old type by examining the output of <code>rosbag info</code> run on a bag that contains the legacy message, or by running <code>rosmsg md5 &lt;old_type&gt;</code> with the correct legacy version of FSW checked out.</li>
<li><code>new_type</code>: The new (frozen) message type name.</li>
<li><code>new_type_md5sum</code>: Determine with <code>rosmsg md5 &lt;new_type&gt;</code>.</li>
</ul>
</li>
<li>The rule is interpreted as follows: if a bag contains messages that match both <code>type = old_type</code> and <code>type_md5sum = old_type_md5sum</code>, those messages will have their type and MD5 sum information rewritten to the new values.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>If you created a new rules file for the package, you may need to add it to the list of rules files that <code>Makefile.rosbag_fix_all</code> looks for.</p>
<ul>
<li>Once your renaming rule is added, <code>rosbag_fix_all.py</code> will apply it as needed.</li>
<li>TODO: Point to an example. (There is already an example written, but it will be merged separately later.)</li>
<li>Verify your new rule as described below.</li>
</ul>
<p>Verifying message rewrite rules:</p>
<ul>
<li>The same approach applies, whether you wrote a migration rule or a type renaming rule.</li>
<li>Run <code>rosbag_fix_all.py</code> on an archived bag containing the legacy message. It automatically applies various consistency checks.</li>
<li>Run <code>rostopic echo -b &lt;bag&gt; -p &lt;topic&gt;</code> on the fixed bag and spot check the field values in the output CSV file.</li>
</ul>
<h2><a class="anchor" id="autotoc_md129"></a>
Ops approach for fixing bags</h2>
<p>As long as FSW keeps evolving with changing message definitions, no matter how many times we apply our automated fix script to an archived bag, a future FSW change could always break its compatibility again.</p>
<p>Therefore, we should take a layered approach to fixing bags:</p>
<ul>
<li>Whenever we make some use of an archived bag, particularly when we publicly release the data, we should try to fix the bag at that time (and create any retroactive migration rules as needed to support that). Regular usage of the fixing script should also help to avoid bit-rot.</li>
<li>Since future FSW changes will continue to break bags, and we don't want to take on the burden of reprocessing all the previously released bags after every breaking message definition change, we should also provide a simple, documented approach for external users to fix them.</li>
</ul>
<p>Usage instructions for fixing bags are documented in: <a class="el" href="using_telemetry.html">Using Astrobee Robot Telemetry Logs</a></p>
<h2><a class="anchor" id="autotoc_md130"></a>
Complementary backward compatibility approach</h2>
<p>This document focuses on maintaining backward compatibility of legacy bags with the ROS tools such as <code>rosbag</code> and <code>rostopic</code> that need the old messages to be compatible with the latest message definition. Clearly, this simplifies uses like testing the latest FSW using legacy bag playback.</p>
<p>However, if all you need is offline analysis outside the ROS tools, the <a href="https://jmscslgroup.github.io/bagpy/"><code>bagpy</code> library</a> for Python 3 is a viable alternative. It relies on the fact that the <code>rosbag</code> format includes complete embedded message definitions, allowing it to deserialize the binary messages and output CSV with named fields, even if the latest ROS packages that define the messages no longer have consistent message definitions. In fact, it doesn't even require a full ROS installation. Fixed bags will never break from the <code>bagpy</code> analysis perspective. Using <code>bagpy</code> may be especially attractive for users who lack prior ROS experience.</p>
<h2><a class="anchor" id="autotoc_md131"></a>
Retroactive migration technical debt</h2>
<p>Since Astrobee went through ISS commissioning in April 2019, there have been several message definition changes that lack corresponding migration rules.</p>
<p>Our developers should retroactively create the necessary migration rules on a lazy as-needed basis. The most common triggering event to create a new rule would be noticing that <code>rosbag_fix_all.py</code> fails on an archived bag during the public data release process. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
