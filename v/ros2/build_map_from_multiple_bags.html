<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Build map from multiple bags</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.0</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('build_map_from_multiple_bags.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Build map from multiple bags </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><br  />
 Several tools exist to ease the process of building a new map from a set of bagfiles. For more options/instructions for each tool, use <br  />
 <code>rosrun package_name tool_name.py -h</code>.</p>
<h2><a class="anchor" id="autotoc_md381"></a>
Steps</h2>
<h3><a class="anchor" id="autotoc_md382"></a>
1. Convert bags from bayer to rgb if necessary</h3>
<p>Assuming the bags are all in the same directory, from that directory use: <br  />
 <code>rosrun bag_processing convert_bayer.py</code> <br  />
</p>
<p>The original bayer bags can now be removed or moved elsewhere.</p>
<h3><a class="anchor" id="autotoc_md383"></a>
2. Splice bags using splice tool</h3>
<p>For each bagfile, use the splice tool with: <br  />
 <code>rosrun bag_processing splice_bag.py bag_name</code> <br  />
</p>
<p>The mapping pipeline struggles with in place rotations, so try to splice a bagfile before and after the rotation if necessary. If the rotation contains enough simultaneous translational movement, do not splice around the rotation since splicing could result in different segments of a movement no longer matching to each other when they are later merged if there is not enough overlap in their images.</p>
<p>If a bag contains multiple movements that contain sufficient overlap, these can be spliced to make the mapping process more efficient (smaller bags are faster to create maps for) and allow for more modular sanity checks (if movements are spliced and one fails to map well, the other may still be usable).</p>
<p>After splicing, the original bags can be removed or moved elsewhere.</p>
<h3><a class="anchor" id="autotoc_md384"></a>
3. Build individual SURF maps for each spliced bag</h3>
<p>Run <br  />
 <code>rosrun <a class="el" href="namespacesparse__mapping.html">sparse_mapping</a> make_surf_maps.py -r robot_name -w world_name</code></p>
<p>This builds individual maps in parallel for each spliced bag in the directory. The mapping process first removes low movement images from a bagfile to prevent triangulation issues and make the mapping process more efficient, then builds a surf map (detects image features, matches features, runs incremental bundle adjustment using successive images, runs a final round of bundle adjustment on the whole map).</p>
<p>View the map poses using <br  />
 <code>rosrun <a class="el" href="namespacesparse__mapping.html">sparse_mapping</a> nvm_visualize -only_poses</code> to ensure the maps were built successfully.</p>
<h3><a class="anchor" id="autotoc_md385"></a>
4. Merge SURF maps</h3>
<p>A common merge strategy for a set of movements is to identify the longest movement that covers the most of an area and incrementally merge in maps that have sufficient overlap with this. Use: <br  />
 <code>rosrun <a class="el" href="namespacesparse__mapping.html">sparse_mapping</a> merge_maps larger_map_name smaller_map_name -output_map combined_map_name -num_image_overlaps_at_endpoints 1000000</code></p>
<p>First merge the new movements together using the above strategy, then optionally merge the resultant combined new movements map into an already existing map (that has some overlap with the new combined movements maps).</p>
<p>View the resulting map poses using <br  />
 <code>rosrun <a class="el" href="namespacesparse__mapping.html">sparse_mapping</a> nvm_visualize -only_poses</code> to ensure the maps were built successfully.</p>
<h3><a class="anchor" id="autotoc_md386"></a>
5. Register SURF map using provided world points</h3>
<p>Since mapping is perfomed using monocular images, no set scale is provied and the map needs to be registered using real world points before being used for localization. Additionally, providing known point locations for images in the map can improve the accuracy of the map creation.</p>
<p>First copy the map that should be registered then run: <br  />
 <code>rosrun <a class="el" href="namespacesparse__mapping.html">sparse_mapping</a> build_map -registration registration_points.pto registration_points.txt -output_map registered_map_name</code></p>
<p>The creation of registration points is detailed in <code><a class="el" href="build__map_8md.html">build_map.md</a></code>, images from the map are used to manually select feature locations and 3D points for these features are selected using a 3D model of the mapped environment provided externally.</p>
<h3><a class="anchor" id="autotoc_md387"></a>
6. Build BRISK map for localization</h3>
<p>Use: <br  />
 <code>rosrun <a class="el" href="namespacesparse__mapping.html">sparse_mapping</a> make_brisk_map.py surf_map_name -r robot_name -w world_name -d map_directory</code> <br  />
 to rebuild the SURF map with BRISK features for use with localization.</p>
<h3><a class="anchor" id="autotoc_md388"></a>
7. Verify BRISK map using localization</h3>
<p>Use: <br  />
 <code>rosrun <a class="el" href="namespacesparse__mapping.html">sparse_mapping</a> run_graph_bag_and_plot_results bag_name brisk_map_name config_path --generate-image-features -r robot_config -w world_name</code> <br  />
 to test the map using localization.</p>
<p>The bags used here should not have been used for map creation but should contain data in the area of the map. If they contain <a class="el" href="structIMU.html">IMU</a> data full localization results will be generated, otherwise only pose estimates using the bag images registered with the provided map will be plotted. Make sure to include the <code>--generate-image-features</code> option to generate new map matches with the provided map.</p>
<p>This script creates a pdf plotting localization accuracy and map-based pose estimates. If the map is well made, the localization and pose estimates should be relatively smooth and consistent. Jumps in these tend to indicate that portions of the map may not be well aligned. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
