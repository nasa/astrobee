<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Choreographer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.0</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('choreographer.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Choreographer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The choreographer is the core of the mobility system and provides six critical functions in support of mobility:</p>
<ol type="1">
<li>It provides a single action topic called <code>/mob/motion</code>, which supports several types of command &ndash; prep, move, execute, stop and idle.</li>
<li>It interacts with the low-level control action to send control goals and monitor the current progress for tolerance errors.</li>
<li>It provides an interface for planners to register themselves at runtime, offering a range of different ways to plan a segment.</li>
<li>It broadcasts the current flight mode, which is used by peer nodes (fam, ctl, ekf) to reconfigure themselves.</li>
<li>It broadcasts the current inertia properties, which are used by peer nodes (fam) to reconfigure themselves.</li>
<li>It broadcasts the current set of keep in and keep out zones, which are used by the mapper to check for collisions and build a clutter map.</li>
</ol>
<h2><a class="anchor" id="autotoc_md444"></a>
Basic operation</h2>
<p>The choreographer supports a number of different motion requests &ndash; <code>executing</code> an existing plan, <code>moving</code> through a sequence of timestamped poses, <code>prepping</code> to a given flight mode, <code>stopping</code> as quickly as possible, and <code>idling</code> the propulsion system. Each request has different data in the payload, and so it makes sense to support multiple action types:</p>
<p>The choreographer provides the callee with a single action-based entry point for control, called <code>ff_msgs::MotionAction</code>. This "motion action" accepts a command &ndash; PREP, MOVE, EXEC, STOP or IDLE &ndash; and carries it out in the background, sending periodic feedback to the callee. When the task completes a result is returned, along with a response code that captures any errors.</p>
<p>The action supports only one goal, which is fully-preemptible. This means that a new goal always preempts the current goal (the previous goal's callee will be notified of preemption). Consequently, you must be careful not to interact with docking action, or any of its dependencies while active.</p>
<h2><a class="anchor" id="autotoc_md445"></a>
Configurable parameters</h2>
<p>The choreographer exposes its configuration through <code>ff_common::ConfigServer</code> class. Thus, the <code>rqt_reconfigure</code> client can be used to change settings manually, or the <code>ff_common::ConfigClient</code> can be used to change the settings programatically.</p>
<p>The following configurable parameters are supported:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Parameter </th><th class="markdownTableHeadLeft">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>planner</code> </td><td class="markdownTableBodyLeft">Which planner to call when a segment needs to be created for a given sequence of poses.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>enable_immediate</code> </td><td class="markdownTableBodyLeft">Whether a segment should be executed immediately, regardless of the first timestamp value. (move, exec)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>enable_validation</code> </td><td class="markdownTableBodyLeft">Whether a segment should be validated by the mapper prior to execution (move, exec).  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>enable_bootstrapping</code> </td><td class="markdownTableBodyLeft">Whether the rsbot should plan a path automatically to move from its current position to the first position of a segment. (exec)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>enable_faceforward</code> </td><td class="markdownTableBodyLeft">Whether the planner should generate a segment where the robot always faces the translation direction. (move)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>enable_collision_checking</code> </td><td class="markdownTableBodyLeft">Whether the choreographer should intervene if the mapper detects an obstacle. (move, exec)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>enable_replanning</code> </td><td class="markdownTableBodyLeft">Whether the choreographer should try and automatically replan around obstacles. (move, exec)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>desired_vel</code> </td><td class="markdownTableBodyLeft">Desired upper bound on linear velocity when planning (move)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>desired_accel</code> </td><td class="markdownTableBodyLeft">Desired upper bound on linear acceleration when planning (move)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>desired_omega</code> </td><td class="markdownTableBodyLeft">Desired upper bound on angular velocity when planning (move)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>desired_alpha</code> </td><td class="markdownTableBodyLeft">Desired upper bound on angular acceleration when planning (move)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>desired_rate</code> </td><td class="markdownTableBodyLeft">Desired sampling rate of segment when planning (move)  </td></tr>
</table>
<p>Additional parameters are supported, but are not reconfigurable.</p>
<p>A replanning approach is implemented to support obstacle avoidance using the qp-planner. To utilize this functionality set the following parameters: <code>planner</code> to "qp", <code>enable_faceforward</code> and <code>enable_collision_checking</code> to true.</p>
<h2><a class="anchor" id="autotoc_md446"></a>
Under the hood</h2>
<p>Internally, the choreographer is encoded as a finite state machine depicted below and implemented using the ff_util/FSM class. This class essentially captures a map of (state, event) -&gt; lambda function relationships. The state of the system is moved forward by setting the initial state and then pushing a sequence of events to the FSM.</p>
<p><div class="dotgraph">
<img src="dot_choreographer_fsm.png" alt="dot_choreographer_fsm.png" border="0" usemap="#dot_choreographer_fsm.map"/>
<div class="caption">
Choreographer finite state machine</div>
</div>
</p>
<h2><a class="anchor" id="autotoc_md447"></a>
Trajectory checks</h2>
<p>To ensure that the robot is following the desired trajectory, the choreographer overviews the controller feedback and cancels the movement if the motion value is above the defined values for a certain amout of time. The parameters are tuned according to the flight mode chosen. A zero value for any of these parameters disables the check.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Parameter </th><th class="markdownTableHeadLeft">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>tolerance_pos_endpoint</code> </td><td class="markdownTableBodyLeft">End of motion position tolerance. Checked when the trajectory finishes and the robot is stopped  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>tolerance_pos</code> </td><td class="markdownTableBodyLeft">Position tolerance checked thoughout the entire trajectory  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>tolerance_vel</code> </td><td class="markdownTableBodyLeft">Velocity tolerance checked thoughout the entire trajectory  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>tolerance_att</code> </td><td class="markdownTableBodyLeft">Attitude tolerance checked thoughout the entire trajectory  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>tolerance_omega</code> </td><td class="markdownTableBodyLeft">Omega tolerance checked thoughout the entire trajectory.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>tolerance_time</code> </td><td class="markdownTableBodyLeft">Time for sync check  </td></tr>
</table>
<p>The planned trajectories are also checked against the keep-in and keep-out zones.</p>
<p>The keep-in and keep-out zones describe safe and unsafe areas for flight respectively. Each zone is a cuboid in 3-space, and is fully-defined by the coordinates of two diagonally opposite vertices. The union of all keep-in zones minus the union of all keep-out zones describes the free space in which safe flight can occur. The default zones are provided as JSON formatted files with suffix <code>.json</code> in the <code>astrobee/gds_config</code> directory.</p>
<p>An example of a keep-in and keep-out zone JSON file might look like this:</p>
<p>{ "timestamp" : "1475516840", "zones": [ { "name" : "keepout", "safe" : false, "sequence" : [ [ -1.0, -0.3, -3, -0.6, 1.0, 3.0 ], [ 0.5, -0.3, -3, 1.0, 1.0, 3.0 ] ] }, { "name" : "keepin", "safe" : true, "sequence" : [ [ -1.5, -1.5, 0, 1.5, 1.5, 3.0 ] ] } ] }</p>
<p>Note that the "sequence" field takes an array of 6-vectors, and not just a single 6-vector. Each element of this array represents a zone, with each vector denoting the two coordinates that fully-define the cuboid.</p>
<p>At any point while running the robot, the operator can load and parse a JSON file: </p><pre class="fragment">`rosrun executive zones_pub -compression none &lt;file_name&gt;.json`
</pre><p>Or manually through the <code>SetZones</code> service call on the ROS namespace <code>~/mob/set_zones</code>. Please refer to the definition of ff_msgs_SetZones for more information on how to update zones using a ROS service call.</p>
<p>The resulting data structure is serialized into a binary file. If the option <code>zone_overwrite</code> in <code>mobility/choreographer.config</code> is activated (default), it will overwrite the current <code>&lt;world&gt;.bin</code> file containing the default set of zones at start-up.</p>
<p>The <a class="el" href="mapper.html">Mapper</a> node publishes <a href="http://docs.ros.org/kinetic/api/visualization_msgs/html/msg/MarkerArray.html">visualization_msgs::MarkerArrays</a> on the namespace <code>~/mob/mapper/zones</code>. When listened to in rviz, these marker arrays render keep-in and keep-out zones as semi-transparent green and red cuboids. The two example zones should be rendered as shown below:</p>
<div class="image">
<img src="zones.png" alt=""/>
<div class="caption">
alt text</div></div>
    </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
