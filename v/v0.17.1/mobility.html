<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Mobility</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.1</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('mobility.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Mobility </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md460"></a>
Overview</h2>
<p>The overarching objective of the mobility subsystem is to provide a clean interface for moving the Astrobee in such a way that avoids obstacles, adheres to kinematic constraints, and keeps within specified flight zones.</p>
<p>It is necessary to first define a few terms that will be used throughout the rest of this document. A FreeFlyer <b>plan</b> comprises of a number of stations (static poses) connected by <b>segments</b> (motion). The executive subsystem splits a plan and feeds the resulting segments one by one to mobility.</p>
<p>A segment is a time-ordered sequence of <b>setpoints</b> and a corresponding <b>flight mode</b>. Each setpoint is a vector containing a pose and its first and second time derivatives, or equivalently a second order curve in 6DoF that describes motion. The flight mode is a string ("nominal", "docking", etc.) that is used to reconfigure the system (set impeller speed, controller gains, planning limits, tolerance values, etc.) so that consistency is enforced. When integrated forward in time by the controller, the setpoint carves out a continous curve in 3D space, defined over the time interval that runs from the current setpoint to the next setpoint, which we call a <b>trajectory</b>.</p>
<div class="image">
<img src="definitions.png" alt=""/>
<div class="caption">
alt text</div></div>
   <h2><a class="anchor" id="autotoc_md461"></a>
Basic operation</h2>
<p>The mobility subsystem provides the callee with a single action-based entry point for control, called <code>ff_msgs::MotionAction</code>. This "motion action" accepts one of the following five commands:</p>
<ol type="1">
<li>PREP - Change the flight mode to some new value. Common values include "off", nominal", "quiet", "difficult". If the new mode has a impeller speed that is different from the current mode, the prep command will ramp the impeller up or down and wait for it to reach its goal before returning.</li>
<li>MOVE - Move the robot through a given set of poses.</li>
<li>EXEC - Execure a specific segment.</li>
<li>IDLE - Null the linear and angular velocities. The robot will try and stop moving, but will not necesserily hold its position.</li>
<li>STOP - Attempt to hold the current position. If the robot is manually moved when in stopped mode, it will detect this and try and hold the new position.</li>
</ol>
<p>The action supports only one goal at a time, which is fully-preemptible. This means that a new goal always preempts the current goal (the previous goal's callee will be notified of preemption). Consequently, you must be careful not to interact with the otion action while active.</p>
<p>The mobility subsystem is comprised of four different nodes.</p>
<ul>
<li><code>Choreographer</code> - The choreographer is the central point of entry to the mobility subsystem. In addition to offering the motion action, it also provides the ability to set keep-in and keep-out zones and inertial properties.</li>
<li><code>Mapper</code> - As its name suggests, the role of the mapper is to maintain a map of environmental clutter. It provides hooks for the choreographer to validate trajectories, and for planners to obtain clutter maps.</li>
<li><code>Trapezoidal planner</code> - The trapezoidal planner is a simple "straight line" planner that assumes the acceleration and velocity on each of the supplied poses is zero. It is unaware of clutter, and is therefore typically used for short movesm, notably in docking and perching.</li>
<li><code>Quadratic Program (QP) planner</code> - The QP planner is more complex planner that generates curved segments that avoid obstacles. Internally it represents the segment by a set of polynomial functions, which can be sampled at any desired rate to generate setpoints.</li>
</ul>
<p>The diagram below illustrates how the various ndoes in the system interact with each other. ROS ctions are drawn in red, while ROS services are drawn in blue. Nodes that are part of the mobility subsystem are drawn as black boxes, while external nodes are drawn as white boxes.</p>
<div class="image">
<img src="mob_overview.png" alt=""/>
<div class="caption">
alt text</div></div>
   <h2><a class="anchor" id="autotoc_md462"></a>
Using the mobility subsystem</h2>
<p>Typically, mobility will be controlled through the Ground Data System (GDS). However, The arm behavior is packaged with its own gflags-based tool called teleop. This tool is essentially a convenience wrapper around an action client can be used to control the arm from the command-line. </p><pre class="fragment">rosrun mobility teleop -helpshort
</pre><p>Here are some examples of how to use the tool. You will need an active simulator to run these examples.</p>
<p>To switch to AR tag localization: </p><pre class="fragment">rosrun mobility teleop -loc ar
</pre><p>To move to coordinate X=0.3 Y=0.4, keeping the Z and rotation the same: </p><pre class="fragment">rosrun mobility teleop -move -pos "0.3 0.4"
</pre><p>To rotate around Z (axis X=0 Y=0 Z=1) by -1.5 radians: </p><pre class="fragment">rosrun mobility teleop -move -att "-1.5 0 0 1"
</pre><p>To switch to AR target localization, use the docking flight mode and move: </p><pre class="fragment">rosrun mobility teleop -loc ar -mode docking -move -pos "0 0"
</pre><p>To use the QP planner to move to X=0.6 Y=0.6: </p><pre class="fragment">rosrun mobility teleop -move -pos "0.6 0.6" -planner qp
</pre><p>At any point one can inspect the internal state of the mobility subsystem using the following command. The command will return a sequence of numbers, which represent a time ordered sequence of states. Please refer to <code>ff_msgs::MotionState</code> for a mapping from numbers to states. </p><pre class="fragment">rostopic echo /mob/motion/state
</pre><p>If you ever need to manually set the motion state to a specific value, you can call the <code>set_state</code> service with the new state as the single argument. </p><pre class="fragment">rosservice call /mob/motion/set_state 1
</pre><h2><a class="anchor" id="autotoc_md463"></a>
Generating a plan from a sequence of poses.</h2>
<p>Given a list of poses (positions in meters, and angles in degrees) the plangen tool can use the trapezoidal planner to create planned trajectory that goes between these poses.</p>
<p>This tool does not enforce the robot following this plan to always face forward. If that is desired, the input poses should be created accordingly.</p>
<p>Since the planner will take the shortest path among two poses, to avoid ambiguity it is suggested that the angles do not change by more than 90 degrees between poses.</p>
<p>Here is an example list of poses in the Kibo module, written as a file named input.txt.</p>
<h1><a class="anchor" id="autotoc_md464"></a>
x    y      z  roll pitch yaw (degrees)</h1>
<p>10.93 -9.2 4.85 0 0 90 10.93 -6.2 4.85 0 0 0</p>
<p>Here the robot will start looking down the length of the module (the largest dimension, which is the Y axis), and move by 3 meters. During that time, the robot's orientation will change from forward to sideways.</p>
<p>Here is another example:</p>
<h3><a class="anchor" id="autotoc_md465"></a>
360 degree yaw rotation at a 45 degree pitch.</h3>
<h3><a class="anchor" id="autotoc_md466"></a>
x    y      z  roll pitch   yaw (degrees)</h3>
<p>10.93 -9.2 4.85 0 0 90 # face forward 10.93 -9.2 4.85 0 45 90 # pitch up at 45 degrees 10.93 -9.2 4.85 0 45 180 # yaw rotation 10.93 -9.2 4.85 0 45 270 # more yaw rotation 10.93 -9.2 4.85 0 45 360 # more yaw rotation 10.93 -9.2 4.85 0 45 90 # back to the original yaw</p>
<p>The planner tool can be invoked as follows:</p>
<p>astrobee_build/native/devel/lib/mobility/plangen -input input.txt \ -output output.fplan -vel 0.2 -accel 0.017 -omega 0.17 -alpha 0.2</p>
<p>It will write the file output.fplan that can be loaded and tested in GDS.</p>
<p>The input options are: </p><pre class="fragment">-vel   : maximum desired linear velocity in m/s
-accel : maximum desired linear acceleration in m/s^2
-omega : maximum desired angular velocity in rads/s
-alpha : maximum desired angular acceleration in rads/s^2
</pre><p>It is very important to note that the order in which the the roll, pitch, and yaw rotations are multiplied gives rise to different rotation matrices. This tool supports the option</p>
<p>-rotations_multiplication_order</p>
<p>The default value is 'yaw-pitch-roll', hence the rotations matrices with these angles are multiplied as</p>
<p>rotation(yaw) * rotation(pitch) * rotation(roll)</p>
<p>As such, the roll rotation happens first, followed by the pitch rotation, and followed by the yaw rotation. This option also supports the value 'roll-pitch-yaw' when the order above is reversed. In total, there are six ways of multiplying these rotation matrices.</p>
<p>Other options can be seen by invoking the -help option.</p>
<h2><a class="anchor" id="autotoc_md467"></a>
Creating acceleration profiles.</h2>
<p>If plangen is invoked with &ndash;output-type csv, it will create acceleration profiles that could be used to control the gantry in MGTF.</p>
<p><a class="el" href="choreographer.html">Choreographer</a> <a class="el" href="framestore.html">Framestore</a> <a class="el" href="mapper.html">Mapper</a> <a class="el" href="planner_qp.html">Quadratic Program (QP) planner</a> <a class="el" href="planner_trapezoidal.html">Trapezoidal planner</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
