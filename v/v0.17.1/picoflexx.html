<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: PicoFlexx</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.1</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('picoflexx.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PicoFlexx </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The PMD PicoFlexx camera is a time of flight sensor that returns depth images, rather than RGB images. The sensor also comes factory calibrated with camera intrinsics and distortion parameters burned into its ROM. Using this information it is possible to project the depth measurements into a point cloud, which is represented in the optical axis. In order to project this into another frame (ISS, body) camera extrinsics are required.</p>
<h1><a class="anchor" id="autotoc_md204"></a>
Utility scripts</h1>
<p><a class="el" href="picoflexx_python.html">Pico Flexx Python utilities</a></p>
<p>The objective of this page is to document an experiment to test the amount of computational resources (CPU load) required to run the PicoFlexx on our target architecture. For the sake of repeatability, this page provides description of the hardware and software setup, and includes attachments that may be of use to the reader.</p>
<h1><a class="anchor" id="autotoc_md205"></a>
Experimental setup</h1>
<h2><a class="anchor" id="autotoc_md206"></a>
Hardware</h2>
<p>The hardware setup is pictured below. It is essentially an Inforce IFC6501 system on module (SOM) plugged into a development board. This board is connected by a USB 2.0 hub to two PMD PicoFlexx sensors, and through Ethernet to a host PC (Ubuntu 16.04 64bit VM). The host PC acts as a DHCP server, NAT router, DNS forwarder and debugger.</p>
<div class="image">
<img src="pico-setup.jpg" alt=""/>
<div class="caption">
alt text</div></div>
   <p>The SOM is fitted with a cooling solution (heatsink and fan) that roughly mimics what is on the actual platform. Thermal testing has shown that by default all cores are run at maximum speed and under high load the CPU frequency switches three of the four cores offline when a thermal barrier is reached. For this reason the following script is run on boot to lower the maximum operating frequency of all four cores to 1.96GHz (they may be throttled lower than this in response to demand).</p>
<p>#!/bin/bash</p>
<p>freq='2.0GHz'</p>
<p>sys_base=/sys/devices/system/cpu</p>
<p>for c in 0 1 2 3; do online=$(cat ${sys_base}/cpu${c}/online) if [[ "$online" -eq "1" ]]; then echo "setting cpu frequency for cpu" ${c} cpufreq-set -c ${c} -u ${freq} else echo "cpu ${c} is off, skipping" fi done</p>
<h2><a class="anchor" id="autotoc_md207"></a>
Software</h2>
<h3><a class="anchor" id="autotoc_md208"></a>
USB patch for Inforce 3.10 kernel</h3>
<p>The default kernel that is shipped with the SOM has a bug in the USB core drivers that prevents the PicoFlexx from being woken up after suspending. Up until now the solution had been to plug a USB 1.1 device into the hub to prevent autosuspend from occurring completely. An alternate software-only solution is to set kernel parameter ''usbcore.autosuspend=-1''. However, in order for this to propagate to the hub, a kernel patch is required.</p>
<p>The kernel patch can be found here: <a href="https://babelfish.arc.nasa.gov/trac/freeflyer/attachment/wiki/pmd_picoflexx/0060-usb2514b-hub-fix.patch">0060-usb2514b-hub-fix.patch</a>. It is included in the kernel build scripts, along with other patches, in the ''./scripts/inforce'' folder of the flight software repository. If you want to build the kernel from scratch, you should use these scripts, otherwise just download a pre-built kernel image: <a href="https://babelfish.arc.nasa.gov/trac/freeflyer/attachment/wiki/ifc6540/kernel_ifc6540_astrobee_mlp_ftdi_overlayfs_usbfix.img">boot.img</a>. Note this kernel image also includes overlayfs and FTDI serial drivers.</p>
<h3><a class="anchor" id="autotoc_md209"></a>
Custom PicoFlexx SDK compilation</h3>
<p>Although PMD now distributes an 32 bit armhf linux binary SDK, there are currently five major issues with it:</p>
<ul>
<li>It is a black box, so we can't see what it's doing or debug it.</li>
<li>It depends on libuvc, which is not packaged with the SDK.</li>
<li>It is not tuned for our architecture.</li>
<li>It is compiled with gcc-4.9, and is not compatible with gcc-4.8.</li>
<li>The default cmake package library path doesn't add the correct directories.</li>
</ul>
<p>The PMD PicoFlexx SDK (called ''libroyale'') is covered by an NDA, and so the source code cannot be uploaded to this wiki. The code itself depends on a ''lispectre'' static library, which implements the time of flight algorithms. We have cross-compiled the SDK for the freeflyer, which is available here: <a href="https://babelfish.arc.nasa.gov/trac/freeflyer/attachment/wiki/pmd_picoflexx/libroyale-2.3.0.0-LINUX-arm-32Bit-FFSW.zip">libroyale-2.3.0.0-LINUX-arm-32Bit-FFSW.zip</a>. Although we have stripped debug symbols from the binary products, we recommend not distributing this zip file outside of the FreeFlyer project until written approval from PMD is received.</p>
<p>If you wish to compile the PicoFlexx SDK from source, you will need to get hold of the <code>spectre-releases-v2.6.5.zip</code> and <code>project-royale-extern-v2.3.0.zip</code> source tarballs. You will need to put these zipfiles along with the <a href="https://babelfish.arc.nasa.gov/trac/freeflyer/attachment/wiki/pmd_picoflexx/0001-spectre.patch">0001-spectre.patch</a> and <a href="https://babelfish.arc.nasa.gov/trac/freeflyer/attachment/wiki/pmd_picoflexx/0002-royale.patch">0002-royale.patch</a> patches, and then run the following script. This script requires that you have a valid freeflyer cross-compile toolchain, ie. arm-linux-gnueabihf-gcc-4.8 and ~/arm_trusty_chroot.</p>
<p>#!/bin/bash</p>
<h1><a class="anchor" id="autotoc_md210"></a>
Install dependencies</h1>
<p>sudo apt-get install libusb-dev cppcheck valgrind -y</p>
<h1><a class="anchor" id="autotoc_md211"></a>
Unzip code</h1>
<p>unzip spectre-releases-v2.6.5.zip -d spectre unzip project-royale-extern-v2.3.0.zip -d royale</p>
<h1><a class="anchor" id="autotoc_md212"></a>
Compile spectre</h1>
<p>pushd spectre patch -p1 &lt; ../0001-spectre.patch mkdir build pushd build cmake -G "Unix Makefiles" -DCMAKE_TOOLCHAIN_FILE=../cmake/toolchain/arm_linux.cmake -DARM_COMPILER_TOOLS=/this/dir/doesnt/matter -DSPECTRE_SYSTEM_TARGET=arm -DBUILD_SHARED_LIBS=OFF -DSPECTRE_BUILD_SHARED=false -DCMAKE_INSTALL_PREFIX=install -DCMAKE_BUILD_TYPE=Release .. make -j6 install popd popd</p>
<h1><a class="anchor" id="autotoc_md213"></a>
Compile royale</h1>
<p>pushd royale patch -p1 &lt; ../0002-royale.patch mkdir build pushd build cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/toolchains/arm_linux.cmake -DROOTFS=~/arm_trusty_chroot -DPROCESSING_SPECTRE_HEADER_DIR=$PWD/../../spectre/build/install/inc -DPROCESSING_SPECTRE_SUBFOLDER=$PWD/../../spectre/build/install/lib -DCMAKE_BUILD_TYPE=Release .. make -j6 install mv install libroyale-2.3.0.0-LINUX-arm-32Bit-FFSW zip -ry ../../libroyale-2.3.0.0-LINUX-arm-32Bit-FFSW.zip libroyale-2.3.0.0-LINUX-arm-32Bit-FFSW popd popd</p>
<p>If all runs successfully, you should have a <code>libroyale-2.3.0.0-LINUX-arm-32Bit-FFSW.zip</code> product in the base folder, which is a binary SDK for the PicoFlexx camera custom-built for the IFC6501 platform.</p>
<h1><a class="anchor" id="autotoc_md214"></a>
Experiments</h1>
<h2><a class="anchor" id="autotoc_md215"></a>
Performance : stock versus custom SDK</h2>
<p>An experiment was conducted to verify that our custom compiled SDK has a similar performance to the stock SDK when run on the IFC6501. The way I chose to do this was to run <a href="http://wiki.ros.org/kinetic/Installation/Ubuntu">ROS Kinetic</a> on a 16.04 minimal Ubuntu root file system, and access the camera through the <a href="https://github.com/code-iai/pico_flexx_driver">pico_flexx_driver</a>. In an effort to separate out the effect of ROS messaging overhead from libroyale computation I wrote a small nodelet called <a href="https://babelfish.arc.nasa.gov/trac/freeflyer/attachment/wiki/pmd_picoflexx/pico_listener.tar.gz">pico_listener</a> that subscribes to a point cloud published by the driver from within the same nodelet manager.</p>
<p>On the target (terminal 1) - to start the camera(s) :</p>
<p>ROS_IP=10.42.0.95 roslaunch pico_listener pico_listener.launch # Case: single camera ROS_IP=10.42.0.95 roslaunch pico_listener pico_listener_pair.launch # Case: dual cameras</p>
<p>On the target (terminal 2) - to record load :</p>
<p>sar 1 30 &gt; data_log.txt</p>
<p>On the host - to configure the camera(s) :</p>
<p>ROS_MASTER_URI=<a href="http://10.42.0.95:11311">http://10.42.0.95:11311</a> ROS_IP=10.42.0.1 rosrun rqt_reconfigure rqt_reconfigure</p>
<p>I recorded load measurements at 1Hz for 30 seconds, and the results are summarized in the diagram below. Results are included for both the single (left column) and dual (right column) camera setups, and for both the stock (top row) and custom-built (bottom row). The x-axis on each graph shows the sample frequency of the camera(s) and the y-axis shows the load as a percentage of <em>all</em> CPUs. Since we have four CPUs, a load of 25% is equivalent to saturating one of the four CPUs. Similarly, a load of 50% is equivalent to saturating two CPUs.</p>
<p>There are a couple of interesting results from this experiment:</p>
<ul>
<li>The custom SDK performance matches the stock SDK performance well, given the confidence intervals.</li>
<li>At the lowest setting (5Hz) running each camera costs approximately 12% of system resources. In other words, two cameras will saturate one of the four cores available.</li>
<li>Oddly enough, running at 15Hz or 35Hz consumes similar resources, but 25% consumes substantially more. Whether this is because they are closer to perfect powers of two is yet to be determined.</li>
</ul>
<p>It is also important to note that, although it is not shown in the results, the output of the pico_flexx_driver showed the point cloud callback rate to be within 1% of the target rate. For this reason, frame dropping cannot be used as a justification for the plateau in load we see from 15Hz onwards.</p>
<div class="image">
<img src="pico-results.jpg" alt=""/>
<div class="caption">
alt text</div></div>
   <p>The raw data for this experiment, as well as the octave code used to generate the plots, is included in <a href="https://babelfish.arc.nasa.gov/trac/freeflyer/attachment/wiki/pmd_picoflexx/matlab-results.tar.gz">matlab-results.tar.gz</a>.</p>
<h2><a class="anchor" id="autotoc_md216"></a>
Performance : pico_flexx_driver vs pico_driver</h2>
<p>The PicoFlexx SDK provides a C++ interface for querying point clouds from the camera. What remains to be done is to extract these point clouds, convert them to an appropriate ROS message type and publish them on the messaging backbone. The ''de faco'' method for doing this is through the <a href="https://github.com/code-iai/pico_flexx_driver">pico_flexx_driver</a>. However, this driver performs extra work &ndash; it allows for dynamic reconfiguration of the camera and also publishes the depth images.</p>
<p>Here we compare the performance of the pico_flexx_driver to that of a light-weight driver written for the FreeFlyer flight software stack. For both drivers we used the same SDK (our custom build) and the ROS Kinetic test environment described in the previous section. We limit our analysis to just the 5Hz mode, because this is the only feasible configuration &ndash; all other moved are too resource-intensive for our application. The results are shown below.</p>
<div class="image">
<img src="pico-drivers.jpg" alt=""/>
<div class="caption">
alt text</div></div>
   <p>Our results show that we are likely to gain a 1% improvement in resource usage by running our <a class="el" href="namespacepico__driver.html">pico_driver</a> rather than the pico_flexx_driver. However, the <a class="el" href="namespacepico__driver.html">pico_driver</a> does need to be updated to distinguish between multiple cameras; it currently just picks the first one that it finds on the bus.</p>
<h2><a class="anchor" id="autotoc_md217"></a>
Performance : optimizing the pico_driver</h2>
<p>The current version of <a class="el" href="namespacepico__driver.html">pico_driver</a> performed an iterative copy of all points from the royale SDK to a point cloud, and then a message conversion from the PointCloud to a PointCloud2 data type. I added the improvements mentioned in the section below, and optimized the code to use a memcpy rather than an iterative copy, by exploiting the fact that the PointCloud2 data type accommodates complex data structures. This yielded a small improvement in speed for low rates, but a massive improvement for higher rates. The results are shown in the graph below:</p>
<div class="image">
<img src="pico-optimization.jpg" alt=""/>
<div class="caption">
alt text</div></div>
   <h1><a class="anchor" id="autotoc_md218"></a>
Setup on a laptop</h1>
<p>In order to test the PicoFlexx on a laptop, several configuration steps are necessary. The cameras.config file located in ../freeflyer/astrobee/config/ must be changed with the correct camera uuid: picoflexx = { api_key = "", devices = { { name = "perch_cam", &ndash; frame topic = "perch", &ndash; frame LINE TO CHANGE --&mdash;&gt; device = "0005-4804-0050-1421", &ndash; camera uuid ("" : automatic) exposure = 0, &ndash; exposure time (0: automatic) mode = "MODE_9_5FPS_2000", &ndash; use case required = true &ndash; is camera required },{ name = "haz_cam", &ndash; frame topic = "haz", &ndash; frame device = robot_haz_cam_device, &ndash; camera uuid ("" : automatic) exposure = 0, &ndash; exposure time (0: automatic) mode = "MODE_9_5FPS_2000", &ndash; use case required = false &ndash; is camera required },{ name = "test_cam", &ndash; special name topic = "test", &ndash; frame device = "0005-4805-0050-1520", &ndash; camera uuid ("" : automatic) exposure = 0, &ndash; exposure time (0: automatic) mode = "MODE_5_45FPS_500", &ndash; use case required = false &ndash; is camera required } } }</p>
<p>To find the camera uuid, run the following executable once the camera is connected to your laptop: ../freeflyer_build/native/devel/lib/pico_driver/pico_tool</p>
<p>If the exectuable returns the message "Could not find any cameras", make sure you give sufficient permissions to the user of the hardware by typing the following command: sudo chmod 666 /PATH/TO/THE/CAMERA</p>
<p>To find the camera, I needed to run the command lsusb which returned: Bus 001 Device 024: ID 1c28:c012 <br  />
</p>
<p>Which means that, in my case, the /PATH/TO/THE/CAMERA is /dev/bus/usb/001/024</p>
<p>Once the camera is found via the pico_tool executable, you can start using the camera. An example of how to see some imagery can be to run the following commands: roslaunch astrobee granite.launch mlp:=local llp:=disabled nodes:=<a class="el" href="namespacepico__driver.html">pico_driver</a>,framestore</p>
<p>And, in another terminal: rosrun rviz rviz</p>
<p>Finally, click the "Add" button in the bottom left corner of the display panel, select "By Topic", and choose /hw/depth_perch/depth_image/Image </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
