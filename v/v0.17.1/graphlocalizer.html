<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Graph Localizer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.1</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('graphlocalizer.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Graph Localizer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md258"></a>
Package Overview</h1>
<p>The GraphLocalizer uses the GraphOptimizer (please first read the documentation in the GraphOptimizer package as this package uses many objects from there) to track the pose, velocity and <a class="el" href="structIMU.html">IMU</a> biases (the set of these three state parameters is referred to as a CombinedNavState) for a robot. It uses a set of measurements (<a class="el" href="structIMU.html">IMU</a>, optical flow, map-based image features, ar tag detections, 3D handrail and wall plane points) to generate factors that constrain its history of CombinedNavStates. <br  />
 </p>
<h2><a class="anchor" id="autotoc_md259"></a>
Code Structure</h2>
<p>The GraphLocalizer package contains the GraphLocalizer, GraphLocalizerWrapper, and GraphLocalizerNodelet objects. The GraphLocalizer handles the creation of factors and contains the GraphOptimizer, while the GraphLocalizerWrapper provides an interface that can be used both online with the GraphLocalizerNodelet and offline in a ROS free environement as is done in the GraphBag tool (see GraphBag package). The GraphLocalizerWrapper converts ROS messages to localization_measurement objects and subsequently passes these to the GraphLocalizer so that the GraphLocalizer does not contain any ROS code. Finally, the GraphLocalizerNodelet is a ROS nodelet that subscribes to the required messages and passes these to the GraphLocalizerWrapper. It also publishes required messages and TFs for online usage.</p>
<h1><a class="anchor" id="autotoc_md260"></a>
Background</h1>
<p>For more information on the theory behind the GraphLocalizer and the factors used, please see our paper (TODO(rsoussan): link paper when publicly available). <br  />
 </p>
<h1><a class="anchor" id="autotoc_md261"></a>
Background (until paper is linked)</h1>
<p>The GraphLocaluzer uses the <code>CombinedImuFactor</code> (<em>Forster, Christian, et al. "IMU preintegration on manifold for efficient visual-inertial maximum-a-posteriori estimation." Georgia Institute of Technology, 2015.</em>) from gtsam which intelligently integrates imu measurements and provides an error function for relative states (consisting of pose, velocity, and imu biases) that depends on each state. Additionally, the graph localizer uses the <code>SmartProjectionFactor</code> (<em>Carlone, Luca, et al. "Eliminating conditionally independent sets in factor graphs: A unifying perspective based on smart factors." 2014 IEEE International Conference on Robotics and Automation (ICRA). IEEE, 2014.</em>) which is a structureless visual odometry factor that combines feature tracks from different camera poses and uses these measurements to estimate first the 3D feature, then project this feature into each measurement to create the factor. The factor is structureless since it does not optimize for the 3D feature, rather it marginalizes this out using a similar null-space projection as presented in (<em>Mourikis, Anastasios I., and Stergios I. Roumeliotis. "A multi-state constraint Kalman filter for vision-aided inertial navigation." Proceedings 2007 IEEE International Conference on Robotics and Automation. IEEE, 2007.</em>). Additionally, image projection measurements from map to image space are incorporated into the graph. <br  />
</p>
<h1><a class="anchor" id="autotoc_md262"></a>
Important Classes</h1>
<h2><a class="anchor" id="autotoc_md263"></a>
Graph Localizer</h2>
<p>The GraphLocalizer is a GraphOptimizer that contains measurement specific FactorAdders and state parameter specific NodeUpdaters. These are detailed further in the following sections.</p>
<h2><a class="anchor" id="autotoc_md264"></a>
FactorAdders</h2>
<h3><a class="anchor" id="autotoc_md265"></a>
LocFactorAdder</h3>
<p>The LocFactorAdder takes map-based image feature measurements and generates either LocProjectionFactors or LocPoseFactors, depeneding on if the LocProjectionFactors suffered cheirality errors or not.</p>
<h3><a class="anchor" id="autotoc_md266"></a>
ProjectionFactorAdder</h3>
<p>The ProjectionFactorAdder creates bundle-adjustment ProjectionFactors for tracked image features. (Not currently used).</p>
<h3><a class="anchor" id="autotoc_md267"></a>
RotationFactorAdder</h3>
<p>The RotationFactorAdder generates a relative rotation using tracked image features in two successive images. (Not currently used).</p>
<h3><a class="anchor" id="autotoc_md268"></a>
SmartProjectionCumulativeFactorAdder</h3>
<p>The SmartProjectionCumulativeFactorAdder generates visual odometry smart factors using image feature tracks. It contains options for the minimum disparity allowed for feature tracks, minimum separation in image space for added feature tracks, whether to use a rotation-only factor if created smart factors suffer from cheirality errors, and more. It can generate factors using maximally spaced measurements in time to include a longer history of measurements while including only a maximum number of total measurements or only include measurements from a given set with a set spacing (toggle these with the use_allowed_timestamps option). <br  />
</p>
<h3><a class="anchor" id="autotoc_md269"></a>
StandstillFactorAdder</h3>
<p>The StandstillFactorAdder creates a zero velocity prior and zero tranform between factor for successive CombinedNavState nodes when standstill is detected. Standstill detection checks for a minimum average disparity for image feature tracks over time.</p>
<h2><a class="anchor" id="autotoc_md270"></a>
Factors</h2>
<h3><a class="anchor" id="autotoc_md271"></a>
LocPoseFactor</h3>
<p>The LocPoseFactor is simply a gtsam::PriorFactor&lt;gtsam::Pose3&gt; that enables the differention of a pose prior from a localization map-based image feature factor.</p>
<h3><a class="anchor" id="autotoc_md272"></a>
LocProjectionFactor</h3>
<p>The LocProjectionFactor is almost a direct copy of the gtsam::ProjectionFactor except it does not optimize for the 3D feature point location.</p>
<h3><a class="anchor" id="autotoc_md273"></a>
PoseRotationFactor</h3>
<p>The PoseRotationFactor constrains two gtsam::Pose3 nodes using their relative rotation.</p>
<h3><a class="anchor" id="autotoc_md274"></a>
PointToHandrailEndpointFactor.h</h3>
<p>The PointToHandrailEndpointFactor constrains a gtsam::Pose3 using a handrail endpoint detection in the sensor frame compared with the closest handrail endpoint from a know handrail.</p>
<h3><a class="anchor" id="autotoc_md275"></a>
PointToLineFactor.h</h3>
<p>The PointToLineFactor constrains a gtsam::Pose3 using a point detection in the sensor frame compared with a line in the world frame.</p>
<h3><a class="anchor" id="autotoc_md276"></a>
PointToLineSegmentFactor.h</h3>
<p>The PointToLineSegmentFactor constrains a gtsam::Pose3 using a point detection in the sensor frame compared with a line segment in the world frame. This factor contains a discontinuity in the Jacobian as there is zero error along the line segment axis if the point is between line segment endpoints and non-zero error otherwise. An option to use a SILU (Sigmoid Linear Unit) approximation is provided for this case.</p>
<h3><a class="anchor" id="autotoc_md277"></a>
PointToPlaneFactor.h</h3>
<p>The PointToPlaneFactor constrains a gtsam::Pose3 using a point detection in the sensor frame compared with a plane in the world frame.</p>
<h3><a class="anchor" id="autotoc_md278"></a>
RobustSmartProjectionFactor</h3>
<p>The RobustSmartProjectionFactor adds to the gtsam::SmartProjectionFactor by providing a robust huber kernel. Additionally, it fixes some issues in the SmartProjectionFactor allowing for a rotation-only fallback when using the JacobianSVD option and allows for proper serialization of the factor.</p>
<h2><a class="anchor" id="autotoc_md279"></a>
NodeUpdaters</h2>
<h3><a class="anchor" id="autotoc_md280"></a>
CombinedNavStateNodeUpdater</h3>
<p>The CombinedNavStateNodeUpdater is responsible for inserting and removing CombinedNavState nodes for the graph. It links nodes using <a class="el" href="structIMU.html">IMU</a> preintegration factors (gtsam::CombinedIMUFactor). If a node to be created's timestamp is between two existing nodes, the <a class="el" href="structIMU.html">IMU</a> factor linking the two existing nodes is split and the new node is inserted between them. The CombinedNavStateNodeUpdater uses the LatestImuIntegrator object to store and utilize <a class="el" href="structIMU.html">IMU</a> measurements. When sliding the window, old nodes are removed from the graph and prior factors are created for the new oldest node using the node's covariances from the most recent round of optimization if the add_priors option is enabled.</p>
<h3><a class="anchor" id="autotoc_md281"></a>
FeaturePointNodeUpdater</h3>
<p>The FeaturePointNodeUpdater maintains feature point nodes for image features. It removes old point nodes that are no longer being tracked by the graph. Creation of point nodes occurs in this case in the ProjectionGraphActionCompleter which uses each measurement of a feature track to triangulate a new point node. (TODO(rsoussan): Update this when this is changed)</p>
<h2><a class="anchor" id="autotoc_md282"></a>
Other</h2>
<h3><a class="anchor" id="autotoc_md283"></a>
FeatureTracker</h3>
<p>The FeatureTracker maintains feature tracks for image based measurements. Feature tracks can be queried using feature ids or by returning the N longest feature tracks. The feature tracker also slides the window for feature tracks to remove old measurements if necessary.</p>
<h3><a class="anchor" id="autotoc_md284"></a>
Sanity Checker</h3>
<p>The SanityChecker validates the current localization pose using a reference pose or by checking that the covariances are within defined bounds. </p>
<h3><a class="anchor" id="autotoc_md285"></a>
GraphLocalizerInitializer</h3>
<p>The GraphLocalizerInitializer is responsible for loading GraphLocalizer parameters. It also stores the starting pose for the localizer and estimates initial <a class="el" href="structIMU.html">IMU</a> biases using a set of N consecutive measurements at standstill.</p>
<h3><a class="anchor" id="autotoc_md286"></a>
GraphLocalizerWrapper</h3>
<p>The GraphLocalizerWrapper contains the GraphLocalizer, GraphLocalizerInitializer, and SanityChecker. It passes ROS messages to each of these and also provides interfaces for accessing some GraphLocalizer data, such as messages built using GraphLocalizer values, estimates of the dock and handrail poses wrt the world frame, and more.</p>
<h3><a class="anchor" id="autotoc_md287"></a>
GraphLocalizerNodelet</h3>
<p>The GraphLocalizerNodlet subscribes to ROS messages for online use and publishes GraphLocalizer messages and TFs.</p>
<h1><a class="anchor" id="autotoc_md288"></a>
Inputs</h1>
<ul>
<li><code>/loc/of/features</code></li>
<li><code>/loc/ml/features</code></li>
<li><code>/loc/ar/features</code></li>
<li><code>/loc/handrail/features</code></li>
<li><code>/hw/imu</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md289"></a>
Outputs</h1>
<ul>
<li><code>graph_loc/graph</code></li>
<li><code>graph_loc/state</code> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
