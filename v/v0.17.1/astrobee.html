<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: General Considerations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.1</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('astrobee.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="structGeneral.html">General</a> Considerations </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md513"></a>
Folder description</h1>
<p>The <code>astrobee</code> folder is the primary entry point into flight software. For example, if you run <code>roslaunch astrobee &lt;launch_file&gt;</code> you are instructing ROS to examine the 'launch' directory in this folder for a XML file called <code>&lt;launch_file&gt;</code>, which describes how to start a specific experiment.</p>
<ol type="1">
<li><code>config</code> - This folder holds all of the configuration files for flight software.</li>
<li><code>launch</code> - Used to launch the flight software stack. Most nodes export also export their own launch and test files.</li>
<li><code>plans</code> - This folder holds plans, which are built using the Ground Data System (GDS) user interface tool.</li>
<li><code>resources</code> - A directory containing all non-LUA resources used by nodes in the system. Additional files might be needed depending on the context.</li>
<li><code>scripts</code> - A simple bash script to print out the environment variables, which can be used to check the context at any point in the launch sequence. A second script to print out the relevant software versions installed on the MLP, LLP, and HLP.</li>
</ol>
<h1><a class="anchor" id="autotoc_md514"></a>
Environment variables</h1>
<ul>
<li><code>ASTROBEE_RESOURCE_DIR</code>: An absolute path to all non-LUA system resources that are used by the nodes in the system. For example, this includes sparse maps, zone files, clutter maps, etc.</li>
<li><code>ASTROBEE_CONFIG_DIR</code>: An absolute path to all LUA config files that store input parameters for the nodes in the system.</li>
<li><code>ASTROBEE_ROBOT</code>: The class of robot. There must be a LUA file at location <code>$ASTROBEE_CONFIG_DIR/robots/$ASTROBEE_ROBOT.config</code>. This file defines intrinsics, extrinsics, hardware serial numbers and calibration info.</li>
<li><code>ASTROBEE_WORLD</code>: The world in which we are operating. There must be a LUA file at location <code>$ASTROBEE_CONFIG_DIR/worlds/$ASTROBEE_WORLD.config</code>. This file defines simulation parameters, zone files, ground truth calibration data, etc.</li>
<li><code>ASTROBEE_NODEGRAPH</code>: If set, this environment variables configures all ff_nodelets to be spawned in standalone mode. This mode results in a more easy to read node and topic structure that.</li>
</ul>
<h1><a class="anchor" id="autotoc_md515"></a>
Context determination</h1>
<p>When launched, nodes must know the context in which they are being launched in order to operate correctly. By context, we mean (a) the robot class being run, (b) the world in which the robot is being run, and (c) paths to both a LUA config and a resource directory. You have flexibility in how this is specified, but note that we enforce the following strict precedence: </p><pre class="fragment">/etc &gt; environment variable &gt; roslaunch arguments &gt; default roslaunch values
</pre><p>For example, consider this launch process run on your local desktop (in this case there will be no <code>/etc/robotname</code> file set by default) </p><pre class="fragment">export ASTROBEE_ROBOT=p4d
roslaunch astrobee sim.launch robot:=p4c
</pre><p>Based on the precedence rules, the environment variable will take precedence over the roslaunch arguments. So, the ROS argument will be completely ignored and a p4d robot will be launched. We advise that, unless you are doing a battery of tests with the same context and want to avoid long roslaunch argument lists, steer clear of environment variables.</p>
<p>The launch is carried out using the hierarchy of launch files shown below. As a developer you can choose to launch at any points marked with a <code>[*]</code>. As a convention, the context is passed down the hierarchy. </p><pre class="fragment">[sim, replay, mgtf, granite, spawn]        [*]
    -&gt; [sim_start]
    -&gt; [astrobee]                          [*]
        -&gt; [llp]
            -&gt; [node] : [ff_nodelet]       [*]
        -&gt; [mlp]
            -&gt; [node] : [ff_nodelet]       [*]
</pre><p>At the package level, nodes inherit from ff_nodelet, and are launched using a pattern defined by ff_nodelet.launch. This pattern respects our context determination hierarchy.</p>
<h1><a class="anchor" id="autotoc_md516"></a>
Default contexts</h1>
<p>Assuming no environment variables are set or <code>/etc</code> files are created, the default contexts defined by the launch files are the following:</p>
<ul>
<li><code>astrobee.launch</code>: robot = {argument}, world = iss, drivers = true</li>
<li><code>sim.launch</code>: robot = sim, world = granite, drivers = false</li>
<li><code>mgtf.launch</code>: robot = p4c, world = mgtf, drivers = true</li>
<li><code>granite.launch</code>: robot = p4d, world = granite, drivers = true</li>
<li><code>replay.launch</code>: robot = p4d, world = granite, drivers = false</li>
<li><code>ff_nodelet.launch</code>: robot = sim, world = granite, drivers = {not applicable}</li>
</ul>
<h1><a class="anchor" id="autotoc_md517"></a>
Remotely launching nodes</h1>
<p>It is possible to launch the MLP, LLP and simulator on remote devices. The corresponding arguments are <code>mlp:=&lt;ip&gt;</code>, <code>llp:=&lt;ip&gt;</code> and <code>sim:=&lt;ip&gt;</code>. There are two special values for <code>&lt;ip&gt;</code>:</p>
<ul>
<li>ip = <code>local</code> : launch on the local machine</li>
<li>ip = <code>disabled</code> : disable this machine completely.</li>
</ul>
<p>The {llp,mlp,sim} arguments with {IP,local,disabled} options is very powerful and supports any configuration of robot with simulated nodes or hardware in the loop.</p>
<h1><a class="anchor" id="autotoc_md518"></a>
Launching only specific nodes</h1>
<p>It is possible to specify on the command line the set of nodes to be launched using the <code>nodes:=&lt;comma_separated_list_of_nodes&gt;</code> argument.</p>
<p>In this case, only the provided nodes will be launched on their destination processors (llp or mlp). In addition, it is possible to avoid roslaunch to perform any connection to a particular processor with the declaration <code>{llp,mlp}:=disabled</code>. This is particularly useful if you need to test some nodes on one processor and do not have access to the other processor.</p>
<p>For example, to test only the picoflexx cameras on the MLP, not attempting connection to the LLP (in case it is absent from the test rig): </p><pre class="fragment">roslaunch astrobee granite.launch llp:=disabled nodes:=pico_driver,framestore
</pre><h1><a class="anchor" id="autotoc_md519"></a>
Launch file examples</h1>
<ol type="1">
<li><p class="startli">Start a local granite simulation with one p4d robot on namespace '/'</p>
<p class="startli"><code>roslaunch astrobee sim.launch</code></p>
</li>
<li><p class="startli">Start a local iss simulation with one p4c robot on namespace '/honey'</p>
<p class="startli"><code>roslaunch astrobee sim.launch world:=iss ns:=honey</code></p>
</li>
<li><p class="startli">Add a second p4d robot to the simulation above on namespace '/bumble'</p>
<p class="startli"><code>roslaunch astrobee spawn.launch world:=iss ns:=bumble</code></p>
</li>
</ol>
<p>See more details in <a class="el" href="running-the-sim.html">Running the Astrobee Simulator</a> for how to run the robot in simulation.</p>
<ol type="1">
<li><p class="startli">Do a processor-in-the-loop simulation</p>
<p class="startli"><code>roslaunch astrobee sim.launch llp:=10.42.0.10 mlp:=10.42.0.11</code></p>
</li>
<li><p class="startli">Launch a simulator remotely but run flight software locally:</p>
<p class="startli"><code>roslaunch astrobee sim.launch sim:=10.42.0.2</code></p>
</li>
<li><p class="startli">Launch the robot 'honey' from systemd with hardware drivers:</p>
<p class="startli"><code>roslaunch astrobee astrobee.launch drivers:=true robot:=honey llp:=&lt;ip&gt;</code></p>
</li>
<li>Launch and introspect the <a class="el" href="namespaceepson__imu.html">epson_imu</a> remotely on some custom llp <div class="fragment"><div class="line">roslaunch astrobee astrobee.launch mlp:=disabled llp:=10.42.0.31</div>
<div class="line">    rqt:=true nodes:=epson_imu</div>
</div><!-- fragment --></li>
<li><p class="startli">Launch granite table and record key data to ~/.ros:</p>
<p class="startli"><code>roslaunch astrobee granite.launch record:=true</code></p>
</li>
<li><p class="startli">Replay the granite table data:</p>
<p class="startli"><code>roslaunch astrobee replay bag:=~/.ros/some.bag</code></p>
</li>
<li>Test a single camera connected to a local machine. For this to work, the file astrobee/config/cameras.config may need to be modified, with the nav_cam device be set from /dev/nav_cam to /dev/video0. Also note that this is known not to work reliably with VirtualBox. Run: <div class="fragment"><div class="line">roslaunch astrobee granite.launch mlp:=local llp:=disabled nodes:=nav_cam,framestore</div>
</div><!-- fragment --></li>
<li>To be able to interact with the robot in its environment using a GUI program, either via teleoperation, or by writing and running a plan, one can use the Astrobee Ground Control Station (GDS). See <a href="https://github.com/nasa/astrobee_gds">https://github.com/nasa/astrobee_gds</a> for detailed instructions for how to install and run GDS.</li>
</ol>
<p>Once GDS is downloaded and extracted, its directory should be renamed to $HOME/gds/latest (hence that directory must have the executable <code>AstroBeeWB</code>).</p>
<p>One should edit the file NDDS_DISCOVERY_PEERS in the GDS directory (see the wiki for its location) to specify the bot's mlp ip address. If running in simulation, one should use 127.0.0.1. (After this GDS needs to be restarted.)</p>
<p>Here's how to launch the robot in simulation using GDS:</p>
<p>roslaunch astrobee sim.launch output:=screen world:=iss gds:=true</p>
<p>It is also possible to launch the robot software without GDS, and start GDS separately. That way more options can be passed to it from the command line that are not supported by the roslaunch interface.</p>
<h1><a class="anchor" id="autotoc_md520"></a>
Roslaunch, [machine] tags, env scripts and environment variables</h1>
<p>The propagation of environment variables through the roslaunch system is not an obvious one to follow. As an example, consider the roslaunch snippet below, taken from some file called test.launch. </p><pre class="fragment">&lt;env name="ASTROBEE_CONFIG_DIR"
     value="$(optenv ASTROBEE_CONFIG_DIR /path/b)"/&gt;              [1]

&lt;machine name="mlp" timeout="10" default="true"
         address="10.42.0.32" user="astrobee" password="astrobee"
         env-loader="/home/astrobee/armhf/env_wrapper.sh"/&gt;       [2]

&lt;env name="ASTROBEE_CONFIG_DIR"
     value="$(optenv ASTROBEE_CONFIG_DIR /path/d)" /&gt;             [3]

&lt;!-- POINT X --&gt;
&lt;node pkg="astrobee" type="check_env.sh" name="check_env"/&gt;       [4]
</pre><p>Assume the following line exists in /home/astrobee/armhf/env_wrapper.sh: </p><pre class="fragment">export ASTROBEE_CONFIG_DIR=/path/c
</pre><p>The resulting value of environment variable <code>ASTROBEE_CONFIG_DIR</code> is obtained by understand how roslaunch files are parsed. It turns out that the whole file is (a) parsed once at the start on the host machine, and (b) environment variables override and do not propagate. As a result of this, the <code>check_env.sh</code> script sees <code>ASTROBEE_CONFIG_DIR=/path/a</code>.</p>
<h2><a class="anchor" id="autotoc_md521"></a>
Takeaway points:</h2>
<ol type="1">
<li>Roslaunch files are parsed once before launching takes place.</li>
<li>Parsing occurs on the on the host side, and so all calls to env() or optenv() obtain values on the host side!</li>
<li>Environment variables override all previous values, and their state does not persist across <code>&lt;env&gt;</code> calls. So, you cannot use <code>&lt;optenv&gt;</code> and <code>&lt;env&gt;</code> to preserve the value of an environment variable within a launch file.</li>
<li>Environment variables declare in roslaunch propagate through machine calls, and override values specified in the env_wrapper. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
