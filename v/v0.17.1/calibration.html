<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NASA Astrobee Robot Software: Calibration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectlogo"><img alt="Logo" src="astrobee-logo.png" height="100"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NASA Astrobee Robot Software
   &#160;<span id="projectnumber">0.17.1</span>
   </div>
   <div id="projectbrief">Flight software for the Astrobee robots operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('calibration.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="structCalibration.html">Calibration</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md599"></a>
Package Overview</h1>
<h1><a class="anchor" id="autotoc_md600"></a>
Camera Target Based Intrinsics Calibration</h1>
<p>This package refines an initial estimate for camera intrinsics and distortion values given a bag file containing images of a calibration target and a calibration target configuration. Several camera distortion models (fov, rad, radtan) are supported for calibration and various scripts are provided to view the quality of the input target detections and the calibration results. <br  />
</p>
<p>For generating an initial estimate of camera intrinsics and distortion values, see <a href="https://github.com/nasa/astrobee/tree/master/scripts/calibrate">https://github.com/nasa/astrobee/tree/master/scripts/calibrate</a>.</p>
<h2><a class="anchor" id="autotoc_md601"></a>
Example Usage</h2>
<p>The following gives an overview of refining calibration parameters given an initial estimate and a bag file containing target detections. For more information on each tool or script and its options, see <a href="#usage-instructions">Usage Instructions</a>. </p>
<h3><a class="anchor" id="autotoc_md602"></a>
Generate target detections from bagfiles</h3>
<p><code>rosrun calibration save_images_with_target_detections -d ~/bag_files -o target_detections -t ~/target.yaml</code> <br  />
 Here <code>~/bag_files</code> contains a directory of bagfiles containing target detection images and target.yaml is the desired target yaml file found in <a href="https://github.com/nasa/astrobee/tree/master/scripts/calibrate/config">https://github.com/nasa/astrobee/tree/master/scripts/calibrate/config</a>. </p>
<h3><a class="anchor" id="autotoc_md603"></a>
View target detection coverage in image space</h3>
<p><code>rosrun calibration view_all_detections.py -d target_detections</code><br  />
</p>
<div class="image">
<img src="detection_image.jpg" alt=""/>
<div class="caption">
Detection Image showing detected target points in image space in green.</div></div>
   <p>Ideally the target detections span the entire image. If only the middle of the image contains detections or if parts of the image have no detections, this may lead to an underconstrained calibration problem. Ensure good target coverage before attempting to calibrate a camera. <br  />
 </p>
<h3><a class="anchor" id="autotoc_md604"></a>
Calibrate</h3>
<h4><a class="anchor" id="autotoc_md605"></a>
Calibration Parameters</h4>
<p>In addition to the script parameters, the camera_target_based_intrinsics_calibrator.config contains most of the configuration options for camera target based intrinsics calibration, found here: <a href="https://github.com/nasa/astrobee/tree/master/astrobee/config/tools/camera_target_based_intrinsics_calibrator.config">https://github.com/nasa/astrobee/tree/master/astrobee/config/tools/camera_target_based_intrinsics_calibrator.config</a>. The distortion model, camera name, parameters for the reprojection pose estimator handling target pose estimation, visualization, and other general parameters can be selected. <br  />
 The parameters to calibrate can also be selected. Depending on the distortion model used, different parameters should be calibrated concurrently to avoid degeneracies and underconstrained calibration. For example, calibrating the camera principal points and target poses at the same time should be avoided. <a class="el" href="structCalibration.html">Calibration</a> may be repeated while incrementally updating solved parameters and toggling different concurrent parameter sets to solve for until all parameters are adequately calibrated. <br  />
 </p>
<h4><a class="anchor" id="autotoc_md606"></a>
Run Calibration</h4>
<p><code>rosrun calibration calibrate_intrinsics_and_save_results.py target_detections ~/astrobee/src/astrobee/config config/robots/bumble.config -u -p -i target_detections -d fov</code> <br  />
 </p>
<h4><a class="anchor" id="autotoc_md607"></a>
Calibration Output</h4>
<p>The calibrated results are saved in the calibrated_params.txt file while more verbose output is saved to the calibration_output.txt file. <br  />
 </p>
<h4><a class="anchor" id="autotoc_md608"></a>
Judging Calibration Results</h4>
<p>Rely primarily on the covariances for each calibrated parameter reported at the end of the calibration_output.txt file. <br  />
 <a class="anchor" id="autotoc_md609"></a></p><h5>Reprojection Image</h5>
<p>The output calibrated_reprojection_from_all_targets_absolute_image.png displays reprojection errors after the calibration procedure has completed and can give a general sense of the calibration accuracy, although it does not discern between accurate calibration and overfitting, which is why the covariances mentioned previously should be the primary indicator of calibration accuracy.<br  />
 Here reprojection errors are colored by the norm of the error on a continuous color spectrum, with dark blue indicated small/zero error and red indicating large error. <br  />
 </p><div class="image">
<img src="calibrated_reprojection_from_all_targets_absolute_image.png" alt=""/>
<div class="caption">
Reprojection image showing error norms, with blue indicating small error and red indicating large error.</div></div>
   <p><a class="anchor" id="autotoc_md610"></a></p><h5>Error Histogram</h5>
<p>The generated error histogram (which displays the overall norm, x, and y errors on seperate plots) can be helpful to view overall error during calibration and to see if any bias exists in the errors. For example, if the x or y error histograms are not zero centered, this can indicate an error in the calibrated principal points. <br  />
 </p><div class="image">
<img src="norm_errors.png" alt=""/>
<div class="caption">
Norm errors</div></div>
   <div class="image">
<img src="x_errors.png" alt=""/>
<div class="caption">
X errors</div></div>
   <div class="image">
<img src="y_errors.png" alt=""/>
<div class="caption">
Y errors</div></div>
   <p>This is generated by passing the -p option to the calibration script or by running the make_error_histograms.py script on the output errors.txt file after calibration has completed.</p>
<p><a class="anchor" id="autotoc_md611"></a></p><h5>Undistorted Images</h5>
<p>The undistorted images generated by passing -u to the calibration script or by seperately running the create_undistorted_images script give an additional indicator of calibration accuracy. Undistorted calibration targets should have straight boundary edges and straight lines within the target. Curved lines can indicate an error in the calibration distortion parameters. <br  />
</p>
<p>Distorted Image:</p>
<div class="image">
<img src="distorted.png" alt=""/>
<div class="caption">
Distorted image.</div></div>
   <p>Undistorted Image (FOV distortion):</p>
<div class="image">
<img src="fov_undistorted.png" alt=""/>
<div class="caption">
FOV undistorted image.</div></div>
   <p>The black dots in the undistorted image are a result of the FOV undistortion procedure, while the Rad and RadTan uses interpolation to fill these.</p>
<h1><a class="anchor" id="autotoc_md612"></a>
Usage Instructions</h1>
<p>For each script and tool, run <code>rosrun calibration script_or_tool_name -h</code> for further details and usage instructions.</p>
<h1><a class="anchor" id="autotoc_md613"></a>
Tools</h1>
<h2><a class="anchor" id="autotoc_md614"></a>
create_undistorted_images</h2>
<p>Generates undistorted images from a set of distorted images and provided camera calibration parameters.</p>
<h2><a class="anchor" id="autotoc_md615"></a>
run_camera_target_based_intrinsics_calibrator</h2>
<p>Runs the intrinsics calibrator using a set of target detection files and initial estimates for the camera intrinsics and distortion values. Support various distortion models.</p>
<h1><a class="anchor" id="autotoc_md616"></a>
Scripts</h1>
<h2><a class="anchor" id="autotoc_md617"></a>
calibrate_intrinsics_and_save_results.py</h2>
<p>Runs camera intrinsic calibration using provided target detections and a config file with camera parameters (including initial estimate for camera intrinsics and distortion values).</p>
<h2><a class="anchor" id="autotoc_md618"></a>
copy_calibration_params_to_config.py</h2>
<p>Helper script that copies calibration parameters from the output of the calibration pipeline and writes these to the camera config file.</p>
<h2><a class="anchor" id="autotoc_md619"></a>
get_bags_with_topic.py</h2>
<p>Helper script that generates a list of bag files in a directory with the provided topic.</p>
<h2><a class="anchor" id="autotoc_md620"></a>
make_error_histograms.py</h2>
<p>Generates a histogram of errors using the output errors from the calibration pipeline.</p>
<h2><a class="anchor" id="autotoc_md621"></a>
save_images_with_target_detections.py</h2>
<p>Generates target detection files for use with the calibration pipeline from a set of bagfiles containing images of target detections.</p>
<h2><a class="anchor" id="autotoc_md622"></a>
view_all_detections.py</h2>
<p>Generates an image containing all images space detections of a target for a set of target detection files. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<script type="text/javascript" src="/astrobee/doc_version_select.js"></script>
</body>
</html>
